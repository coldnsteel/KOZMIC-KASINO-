<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ğŸ° Monster Kozmic Casino - COMPLETE EDITION ğŸŒŒ</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r169/three.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/web3/4.5.0/web3.min.js"></script>
<style>
* { margin: 0; padding: 0; box-sizing: border-box; }
body {
  font-family: 'Courier New', 'Lucida Console', monospace;
  background: linear-gradient(45deg, #0a0a0a, #1a0033, #330066, #000066, #660033, #330011);
  background-size: 600% 600%;
  color: #ffffff;
  min-height: 100vh;
  animation: cosmicHypnosis 12s ease-in-out infinite;
  overflow-x: hidden;
}

@keyframes cosmicHypnosis {
  0% { background-position: 0% 50%; filter: hue-rotate(0deg); }
  16.66% { background-position: 16% 30%; filter: hue-rotate(60deg); }
  33.33% { background-position: 33% 70%; filter: hue-rotate(120deg); }
  50% { background-position: 50% 20%; filter: hue-rotate(180deg); }
  66.66% { background-position: 66% 80%; filter: hue-rotate(240deg); }
  83.33% { background-position: 83% 40%; filter: hue-rotate(300deg); }
  100% { background-position: 100% 50%; filter: hue-rotate(360deg); }
}

.header {
  text-align: center;
  padding: 25px;
  background: rgba(0,0,0,0.85);
  backdrop-filter: blur(15px);
  border-bottom: 4px solid #ff6b9d;
  box-shadow: 0 4px 30px rgba(255, 107, 157, 0.3);
}

.header h1 {
  font-size: 3.2em;
  background: linear-gradient(45deg, #ff6b9d, #4ecdc4, #ffd700, #ff00ff, #00ffff);
  background-size: 400% 400%;
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  background-clip: text;
  animation: titleRainbow 4s ease-in-out infinite, titlePulse 2s ease-in-out infinite;
  text-shadow: 0 0 30px rgba(255, 107, 157, 0.8);
  margin-bottom: 15px;
  letter-spacing: 3px;
}

@keyframes titleRainbow {
  0%, 100% { background-position: 0% 50%; }
  50% { background-position: 100% 50%; }
}

@keyframes titlePulse {
  0%, 100% { transform: scale(1); }
  50% { transform: scale(1.05); }
}

.container {
  max-width: 1600px;
  margin: 0 auto;
  padding: 25px;
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
  gap: 25px;
}

.module {
  background: linear-gradient(135deg, rgba(44, 44, 78, 0.95), rgba(20, 20, 40, 0.95));
  border: 3px solid transparent;
  border-radius: 20px;
  padding: 25px;
  position: relative;
  backdrop-filter: blur(10px);
  box-shadow: 0 8px 40px rgba(0, 0, 0, 0.6);
  transition: all 0.4s cubic-bezier(0.23, 1, 0.320, 1);
  overflow: hidden;
}

.module::before {
  content: '';
  position: absolute;
  top: 0; left: 0; right: 0; bottom: 0;
  background: linear-gradient(45deg, #ff6b9d, #4ecdc4, #ffd700, #ff00ff);
  background-size: 400% 400%;
  animation: borderFlow 6s ease-in-out infinite;
  border-radius: 20px;
  padding: 3px;
  mask: linear-gradient(#fff 0 0) content-box, linear-gradient(#fff 0 0);
  mask-composite: subtract;
  -webkit-mask-composite: xor;
}

@keyframes borderFlow {
  0%, 100% { background-position: 0% 50%; }
  50% { background-position: 100% 50%; }
}

.module:hover {
  transform: translateY(-8px) scale(1.02);
  box-shadow: 0 15px 60px rgba(255, 107, 157, 0.4);
}

.module h2 {
  color: #ff6b9d;
  text-align: center;
  margin-bottom: 20px;
  font-size: 1.6em;
  text-shadow: 0 0 15px rgba(255, 107, 157, 0.7);
  text-transform: uppercase;
  letter-spacing: 2px;
  position: relative;
  z-index: 2;
}

.cosmic-slot-machine {
  display: flex;
  justify-content: center;
  align-items: center;
  gap: 20px;
  margin: 25px 0;
  background: linear-gradient(135deg, #1a1a2e, #16213e, #0f3460);
  border: 4px solid #ffd700;
  border-radius: 20px;
  padding: 30px;
  box-shadow: inset 0 0 30px rgba(255, 215, 0, 0.3), 0 0 50px rgba(255, 215, 0, 0.6);
  position: relative;
  overflow: hidden;
}

.cosmic-slot-machine::before {
  content: '';
  position: absolute;
  top: -50%; left: -50%;
  width: 200%; height: 200%;
  background: conic-gradient(transparent, rgba(255, 215, 0, 0.1), transparent, rgba(255, 215, 0, 0.1));
  animation: slotMachineRotate 4s linear infinite;
}

@keyframes slotMachineRotate {
  0% { transform: rotate(0deg); }
  100% { transform: rotate(360deg); }
}

.reel {
  width: 90px; height: 90px;
  background: linear-gradient(135deg, #000000, #1a1a1a, #000000);
  border: 4px solid #ff6b9d;
  border-radius: 15px;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 52px;
  position: relative;
  z-index: 2;
  transition: all 0.3s cubic-bezier(0.68, -0.55, 0.265, 1.55);
  cursor: pointer;
  overflow: hidden;
  box-shadow: inset 0 0 20px rgba(0, 0, 0, 0.8), 0 0 20px rgba(255, 107, 157, 0.5);
}

.reel.spinning {
  animation: reelSpinCrazy 0.15s linear infinite;
  border-color: #ffd700;
  box-shadow: 0 0 40px rgba(255, 215, 0, 0.8);
  transform: scale(1.1);
}

.reel.winner {
  animation: reelWinPulse 1s ease-in-out infinite;
  border-color: #00ff00;
  box-shadow: 0 0 50px rgba(0, 255, 0, 1);
  transform: scale(1.2);
}

.reel.jackpot {
  animation: reelJackpotExplosion 0.5s ease-in-out infinite;
  border-color: #ffd700;
  box-shadow: 0 0 80px rgba(255, 215, 0, 1);
  transform: scale(1.3);
}

@keyframes reelSpinCrazy {
  0% { transform: rotateY(0deg) rotateZ(0deg); background: linear-gradient(45deg, #ff0000, #00ff00); }
  25% { transform: rotateY(90deg) rotateZ(90deg); background: linear-gradient(45deg, #00ff00, #0000ff); }
  50% { transform: rotateY(180deg) rotateZ(180deg); background: linear-gradient(45deg, #0000ff, #ffff00); }
  75% { transform: rotateY(270deg) rotateZ(270deg); background: linear-gradient(45deg, #ffff00, #ff00ff); }
  100% { transform: rotateY(360deg) rotateZ(360deg); background: linear-gradient(45deg, #ff00ff, #ff0000); }
}

@keyframes reelWinPulse {
  0%, 100% { transform: scale(1.2) rotate(0deg); box-shadow: 0 0 50px rgba(0, 255, 0, 1); }
  50% { transform: scale(1.4) rotate(5deg); box-shadow: 0 0 80px rgba(0, 255, 0, 1); }
}

@keyframes reelJackpotExplosion {
  0% { transform: scale(1.3) rotate(0deg); box-shadow: 0 0 80px rgba(255, 215, 0, 1); filter: brightness(1); }
  50% { transform: scale(1.6) rotate(10deg); box-shadow: 0 0 150px rgba(255, 215, 0, 1); filter: brightness(2); }
  100% { transform: scale(1.3) rotate(0deg); box-shadow: 0 0 80px rgba(255, 215, 0, 1); filter: brightness(1); }
}

.btn {
  background: linear-gradient(135deg, #ff6b9d, #4ecdc4);
  border: none;
  padding: 16px 28px;
  border-radius: 30px;
  color: white;
  cursor: pointer;
  font-weight: bold;
  margin: 8px;
  transition: all 0.3s cubic-bezier(0.68, -0.55, 0.265, 1.55);
  font-family: inherit;
  font-size: 16px;
  text-transform: uppercase;
  letter-spacing: 1px;
  position: relative;
  overflow: hidden;
  box-shadow: 0 4px 15px rgba(255, 107, 157, 0.4);
}

.btn::before {
  content: '';
  position: absolute;
  top: 0; left: -100%;
  width: 100%; height: 100%;
  background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.3), transparent);
  transition: left 0.5s;
}

.btn:hover::before { left: 100%; }

.btn:hover {
  transform: translateY(-4px) scale(1.05);
  box-shadow: 0 8px 30px rgba(255, 107, 157, 0.6);
  background: linear-gradient(135deg, #4ecdc4, #ff6b9d);
}

.btn:active {
  transform: translateY(-2px) scale(1.02);
  animation: btnShockwave 0.6s ease-out;
}

.btn.spin-btn {
  background: linear-gradient(135deg, #ffd700, #ff8c00);
  border: 3px solid #ffd700;
  font-size: 20px;
  padding: 22px 40px;
  box-shadow: 0 6px 25px rgba(255, 215, 0, 0.6);
  text-shadow: 0 0 10px rgba(0, 0, 0, 0.8);
}

.btn.spin-btn:hover {
  background: linear-gradient(135deg, #ff8c00, #ffd700);
  box-shadow: 0 10px 40px rgba(255, 215, 0, 0.8);
  transform: translateY(-6px) scale(1.1);
}

.btn.web3 {
  background: linear-gradient(135deg, #8a2be2, #4b0082);
  border: 2px solid #9370db;
  box-shadow: 0 4px 15px rgba(138, 43, 226, 0.4);
}

.btn.web3:hover {
  background: linear-gradient(135deg, #4b0082, #8a2be2);
  box-shadow: 0 8px 30px rgba(138, 43, 226, 0.6);
}

.btn.disabled {
  background: #666 !important;
  cursor: not-allowed !important;
  opacity: 0.6 !important;
  transform: none !important;
}

@keyframes btnShockwave {
  0% { box-shadow: 0 0 0 0 rgba(255, 107, 157, 0.7); }
  70% { box-shadow: 0 0 0 20px rgba(255, 107, 157, 0); }
  100% { box-shadow: 0 0 0 0 rgba(255, 107, 157, 0); }
}

.cosmic-balance {
  font-size: 28px;
  font-weight: bold;
  color: #ffd700;
  text-align: center;
  margin: 20px 0;
  text-shadow: 0 0 20px rgba(255, 215, 0, 0.8);
  background: rgba(0, 0, 0, 0.5);
  padding: 15px;
  border-radius: 15px;
  border: 2px solid #ffd700;
  position: relative;
  overflow: hidden;
}

.cosmic-balance::before {
  content: '';
  position: absolute;
  top: 0; left: -100%;
  width: 100%; height: 100%;
  background: linear-gradient(90deg, transparent, rgba(255, 215, 0, 0.2), transparent);
  animation: balanceShimmer 3s ease-in-out infinite;
}

@keyframes balanceShimmer {
  0% { left: -100%; }
  50% { left: 0%; }
  100% { left: 100%; }
}

.prize-display {
  text-align: center;
  color: #ffd700;
  font-size: 20px;
  font-weight: bold;
  margin: 25px 0;
  padding: 20px;
  background: linear-gradient(135deg, rgba(255, 215, 0, 0.1), rgba(255, 140, 0, 0.1));
  border-radius: 15px;
  border: 3px solid #ffd700;
  text-shadow: 0 0 15px rgba(255, 215, 0, 0.8);
  min-height: 80px;
  display: flex;
  align-items: center;
  justify-content: center;
  position: relative;
  overflow: hidden;
}

.prize-display.jackpot {
  animation: prizeJackpotCelebration 1s ease-in-out infinite;
  background: linear-gradient(135deg, rgba(255, 215, 0, 0.3), rgba(255, 20, 147, 0.3));
  border-color: #ff1493;
}

@keyframes prizeJackpotCelebration {
  0%, 100% {
    transform: scale(1) rotate(0deg);
    background: linear-gradient(135deg, rgba(255, 215, 0, 0.3), rgba(255, 20, 147, 0.3));
  }
  25% {
    transform: scale(1.1) rotate(1deg);
    background: linear-gradient(135deg, rgba(255, 20, 147, 0.5), rgba(0, 255, 255, 0.3));
  }
  50% {
    transform: scale(1.2) rotate(0deg);
    background: linear-gradient(135deg, rgba(0, 255, 255, 0.5), rgba(255, 215, 0, 0.5));
  }
  75% {
    transform: scale(1.1) rotate(-1deg);
    background: linear-gradient(135deg, rgba(255, 215, 0, 0.5), rgba(255, 20, 147, 0.3));
  }
}

.status {
  background: rgba(0, 0, 0, 0.7);
  padding: 18px;
  border-radius: 12px;
  border-left: 5px solid #4ecdc4;
  font-family: 'Courier New', monospace;
  font-size: 13px;
  margin: 18px 0;
  max-height: 150px;
  overflow-y: auto;
  box-shadow: inset 0 0 10px rgba(0, 0, 0, 0.5);
}

.status::-webkit-scrollbar { width: 8px; }
.status::-webkit-scrollbar-track { background: rgba(0, 0, 0, 0.3); border-radius: 4px; }
.status::-webkit-scrollbar-thumb { background: linear-gradient(45deg, #ff6b9d, #4ecdc4); border-radius: 4px; }

.cosmic-visual {
  width: 100%;
  height: 220px;
  background: linear-gradient(135deg, #2c2c4e, #1a1a2e);
  border-radius: 15px;
  overflow: hidden;
  margin: 20px 0;
  border: 3px solid #4ecdc4;
  position: relative;
  box-shadow: inset 0 0 20px rgba(0, 0, 0, 0.5);
}

#webglCanvas, #spectrumCanvas {
  width: 100%;
  height: 100%;
  border-radius: 12px;
}

.overlay {
  position: absolute;
  top: 12px; left: 12px;
  background: rgba(0, 0, 0, 0.8);
  padding: 8px 12px;
  border-radius: 8px;
  font-size: 12px;
  color: #4ecdc4;
  backdrop-filter: blur(5px);
}

.controls {
  display: flex;
  flex-direction: column;
  gap: 18px;
  position: relative;
  z-index: 2;
}

.control-row {
  display: flex;
  gap: 12px;
  flex-wrap: wrap;
  justify-content: center;
}

select, input[type="range"], input[type="number"] {
  background: rgba(44, 44, 78, 0.9);
  color: white;
  border: 2px solid #4ecdc4;
  padding: 12px;
  border-radius: 10px;
  font-family: inherit;
  font-size: 14px;
}

select:focus, input:focus {
  outline: none;
  border-color: #ff6b9d;
  box-shadow: 0 0 15px rgba(255, 107, 157, 0.4);
}

.achievement {
  background: linear-gradient(45deg, #ff6b9d, #4ecdc4);
  padding: 6px 12px;
  border-radius: 20px;
  margin: 3px;
  font-size: 11px;
  display: inline-block;
  box-shadow: 0 2px 8px rgba(255, 107, 157, 0.3);
  animation: achievementGlow 2s ease-in-out infinite;
}

@keyframes achievementGlow {
  0%, 100% { box-shadow: 0 2px 8px rgba(255, 107, 157, 0.3); }
  50% { box-shadow: 0 4px 16px rgba(255, 107, 157, 0.6); }
}

.cosmic-creature {
  position: fixed;
  bottom: 25px; right: 25px;
  width: 80px; height: 80px;
  background: radial-gradient(circle, #ff6b9d, #4ecdc4, #ffd700);
  border-radius: 50%;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 32px;
  animation: creatureFloat 4s ease-in-out infinite;
  z-index: 1000;
  border: 4px solid #fff;
  box-shadow: 0 0 30px rgba(255, 107, 157, 0.8);
  transition: all 0.3s ease;
}

.cosmic-creature:hover {
  transform: scale(1.2) rotate(10deg);
  animation-duration: 1s;
}

@keyframes creatureFloat {
  0%, 100% { transform: translateY(0px) rotate(0deg); }
  25% { transform: translateY(-8px) rotate(5deg); }
  50% { transform: translateY(-4px) rotate(0deg); }
  75% { transform: translateY(-12px) rotate(-5deg); }
}

.screen-flash {
  position: fixed;
  top: 0; left: 0;
  width: 100%; height: 100%;
  background: radial-gradient(circle, rgba(255, 215, 0, 0.8), transparent);
  pointer-events: none;
  z-index: 9999;
  animation: screenFlashEffect 0.5s ease-out;
}

@keyframes screenFlashEffect {
  0% { opacity: 0; transform: scale(0); }
  50% { opacity: 1; transform: scale(1.2); }
  100% { opacity: 0; transform: scale(2); }
}

@media (max-width: 768px) {
  .container { grid-template-columns: 1fr; gap: 15px; padding: 15px; }
  .header h1 { font-size: 2.2em; }
  .reel { width: 65px; height: 65px; font-size: 36px; }
  .cosmic-slot-machine { gap: 12px; padding: 20px; }
  .btn { padding: 12px 20px; font-size: 14px; }
  .cosmic-creature { bottom: 15px; right: 15px; width: 60px; height: 60px; font-size: 24px; }
}
</style>
</head>
<body>

<div class="header">
  <h1>ğŸ° MONSTER KOZMIC CASINO ğŸŒŒ ğŸ’€</h1>
  <p>ğŸƒ <strong>COMPLETE EDITION</strong> - The Ultimate Cosmic Gaming Experience ğŸƒ</p>
  <p style="font-size: 1.1em;">ğŸ¸ Professional Music Production â€¢ ğŸ° Web3 Casino â€¢ ğŸŒ€ Consciousness Expansion â€¢ ğŸ² Cosmic Slot Machine</p>
  <p style="font-size: 0.9em; opacity: 0.8;">ğŸ¤– AI Joker Supreme Collaboration: Claude + Grok = Infinite Possibilities</p>
</div>

<div class="container">
  <!-- COSMIC SLOT MACHINE - FLAGSHIP FEATURE -->
  <div class="module">
    <h2>ğŸ° Cosmic Slot Machine Supreme ğŸƒ</h2>
    <div class="cosmic-balance" id="cosmicBalance">ğŸ’° CTOK: 1000</div>
    <div class="cosmic-slot-machine">
      <div class="reel" id="reel1" onclick="testReel(1)">ğŸ¸</div>
      <div class="reel" id="reel2" onclick="testReel(2)">ğŸ¹</div>
      <div class="reel" id="reel3" onclick="testReel(3)">ğŸ’€</div>
    </div>
    <div class="controls">
      <button class="btn spin-btn" onclick="spinCosmicSlots()" id="cosmicSpinBtn">
        ğŸ² SPIN COSMIC REELS (50 CTOK) ğŸ²
      </button>
      <div class="control-row">
        <button class="btn" onclick="godMode()">ğŸƒ GOD MODE</button>
        <button class="btn" onclick="testUltimateJackpot()">ğŸ† TEST JACKPOT</button>
        <button class="btn" onclick="addCosmicCTOK()">ğŸ’° ADD CTOK</button>
      </div>
    </div>
    <div class="prize-display" id="cosmicPrizeDisplay">
      ğŸŒŸ Spin the cosmic reels for legendary rewards! ğŸŒŸ<br>
      ğŸ¸ğŸ¸ğŸ¸ = Cosmic Guitar | ğŸ¹ğŸ¹ğŸ¹ = Quantum Piano | ğŸ’€ğŸ’€ğŸ’€ = Death Metal<br>
      ğŸŒŸğŸŒŸğŸŒŸ = Supernova | ğŸƒğŸƒğŸƒ = ULTIMATE KWEPIE NFT JACKPOT!
    </div>
    <div class="status" id="slotStatus">
      ğŸ° COSMIC SLOT MACHINE READY<br>
      ğŸ² Current Symbols: ğŸ¸ ğŸ¹ ğŸ’€ ğŸŒŸ ğŸƒ<br>
      ğŸ’« Win Conditions: 3 Match = Major Prize | 2 Match + ğŸƒ = Bonus<br>
      ğŸ† Ultimate Jackpot: ğŸƒğŸƒğŸƒ = Kwepie NFT + Chaos Mode<br>
      âš¡ Click individual reels to test symbols!
    </div>
  </div>

  <!-- COSMIC INPUT PORTAL -->
  <div class="module">
    <h2>ğŸŒ€ Cosmic Input Portal</h2>
    <div class="controls">
      <select id="inputType">
        <option value="cosmic-all">ğŸŒŒ COSMIC ALL!</option>
        <option value="guitar">ğŸ¸ Guitar Input</option>
        <option value="microphone">ğŸ™ Microphone</option>
        <option value="trepanning">ğŸ’€ Trepanning Mode</option>
        <option value="hypernova">ğŸŒ‹ Hypernova Input</option>
      </select>
      <div class="control-row">
        <button class="btn" onclick="openCosmicPortal()">ğŸŒ€ Open Portal</button>
        <button class="btn" onclick="toggleTrepanMode()">ğŸ’€ Trepan Mode</button>
        <button class="btn" onclick="activateHypernova()">ğŸŒ‹ Hypernova</button>
        <button class="btn" onclick="emergencyPortalStop()">ğŸ›‘ Emergency</button>
      </div>
      <div class="cosmic-visual">
        <canvas id="webglCanvas"></canvas>
        <div class="overlay" id="portalOverlay">Portal: Standby</div>
      </div>
      <div class="status" id="portalStatus">
        ğŸŒ€ Cosmic Portal Status: READY<br>
        ğŸ® WebGL: Initializing...<br>
        ğŸ”Š Audio: Standby<br>
        ğŸ’€ Trepan Level: 5/10<br>
        âš¡ Ready for consciousness expansion!
      </div>
    </div>
  </div>

  <!-- GENRE WHEEL SUPREME -->
  <div class="module">
    <h2>ğŸ² Universal Genre Wheel</h2>
    <div class="controls">
      <select id="genreSelect" onchange="changeCosmicGenre()">
        <option value="standard">ğŸµ Standard</option>
        <option value="motown">ğŸ¶ Motown (Funk Brothers)</option>
        <option value="wrecking_crew">ğŸ¸ Wrecking Crew (LA Studio)</option>
        <option value="reggae">ğŸŒ´ Reggae Vibes</option>
        <option value="psychedelic">ğŸŒˆ Psychedelic Rock</option>
        <option value="indian_classical">ğŸ•‰ Indian Classical</option>
        <option value="african_polyrhythm">ğŸ¥ African Polyrhythms</option>
        <option value="cosmic_fusion">ğŸŒŒ Cosmic Fusion</option>
      </select>
      <div id="genreInfo" class="cosmic-balance" style="font-size: 16px;">
        ğŸµ Genre: Standard | BPM: 120 | Key: C Major
      </div>
      <div id="instrumentGrid" class="control-row"></div>
      <div class="control-row">
        <button class="btn" onclick="randomGenreJam()">ğŸ² Random Jam</button>
        <button class="btn" onclick="ultimateGenreFusion()">ğŸŒŒ Genre Fusion</button>
      </div>
      <div class="status" id="genreStatus">
        ğŸ² Genre Wheel: READY<br>
        ğŸµ Active Instruments: 8<br>
        ğŸ¹ Use keys 0-7 to play instruments<br>
        ğŸ¼ Use Q-P for piano roll<br>
        ğŸŒŸ Each genre has unique sound characteristics!
      </div>
    </div>
  </div>

  <!-- UAD PLUGIN FORTRESS -->
  <div class="module">
    <h2>ğŸ› UAD Plugin Fortress</h2>
    <div class="controls">
      <div id="uadRack" class="control-row"></div>
      <div class="control-row">
        <button class="btn" onclick="loadUADPresets()">ğŸ› Load Presets</button>
        <button class="btn" onclick="resetAllPlugins()">ğŸ”„ Reset All</button>
        <button class="btn" onclick="bypassAllPlugins()">â¸ Bypass All</button>
        <button class="btn" onclick="chaosPluginMode()">ğŸƒ Chaos Mode</button>
      </div>
      <div class="status" id="uadStatus">
        ğŸ› UAD Plugin Fortress: OPERATIONAL<br>
        ğŸ”§ Total Plugins: 12<br>
        âš¡ Active: 0 | Bypassed: 0<br>
        ğŸš Click: Toggle On/Off | Right-Click: Bypass<br>
        ğŸŒŸ Genre presets available!
      </div>
    </div>
  </div>

  <!-- WEB3 COSMIC CASINO -->
  <div class="module">
    <h2>ğŸ° Web3 Cosmic Casino</h2>
    <div class="controls">
      <div class="cosmic-balance" id="web3Balance">
        ğŸ‘› Wallet: Disconnected | ğŸ’° CTOK: 0 | ğŸ§  Portals: 0 | ğŸ¨ NFTs: 0
      </div>
      <div class="control-row">
        <button class="btn web3" onclick="connectCosmicWallet()">ğŸ‘› Connect Wallet</button>
        <button class="btn web3" onclick="mintCosmicNFT()">ğŸ¨ Mint NFT</button>
        <button class="btn web3" onclick="drillMindPortal()">ğŸ§  Drill Portal</button>
      </div>
      <div class="control-row">
        <button class="btn web3" onclick="supernovaBet()">ğŸŒŸ Supernova Bet</button>
        <button class="btn web3" onclick="blackHoleLottery()">ğŸ•³ Black Hole Lottery</button>
        <button class="btn web3" onclick="cosmicStaking()">ğŸ’ Cosmic Staking</button>
      </div>
      <label style="color: #ffd700; margin: 10px 0;">Bet Amount (CTOK):</label>
      <input type="number" id="betAmount" min="1" max="10000" value="100" style="width: 100%; margin-bottom: 15px;">
      <div id="achievementsPanel"></div>
      <div class="status" id="web3Status">
        ğŸ° Web3 Casino: READY<br>
        ğŸ”— Blockchain: Polygon Network<br>
        ğŸ’ Smart Contract: Deployed<br>
        ğŸ† Achievement System: Active<br>
        ğŸ² Connect wallet to start gaming!
      </div>
    </div>
  </div>

  <!-- COSMIC RECORDING STUDIO -->
  <div class="module">
    <h2>ğŸ™ Cosmic Recording Studio</h2>
    <div class="controls">
      <div class="control-row">
        <button class="btn" id="recordBtn" onclick="toggleCosmicRecording()">ğŸ™ Record Mix</button>
        <button class="btn" onclick="playbackRecording()">â–¶ Playback</button>
        <button class="btn" onclick="downloadCosmicMix()">ğŸ’¾ Download</button>
        <button class="btn" onclick="exportToNFT()">ğŸ¨ Export to NFT</button>
      </div>
      <div class="cosmic-visual">
        <canvas id="spectrumCanvas"></canvas>
        <div class="overlay">Spectrum Analyzer</div>
      </div>
      <div id="trackList" class="status" style="max-height: 100px;">
        ğŸµ No recordings yet. Start recording to see tracks here!
      </div>
      <div class="status" id="recordingStatus">
        ğŸ™ Recording Studio: READY<br>
        ğŸ“Š Format: WebM + MP3 Export<br>
        ğŸµ Quality: High Definition<br>
        â± Max Duration: 10 minutes<br>
        ğŸŒŸ Recordings can be minted as NFTs!
      </div>
    </div>
  </div>

  <!-- PROFESSIONAL MIXING CONSOLE -->
  <div class="module">
    <h2>ğŸš Professional Mixing Console</h2>
    <div class="controls">
      <div id="mixerTracks" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(100px, 1fr)); gap: 10px; margin: 20px 0;"></div>
      <div class="control-row">
        <button class="btn" onclick="addMixerTrack()">â• Add Track</button>
        <button class="btn" onclick="masterProcessing()">ğŸ› Master Processing</button>
        <button class="btn" onclick="automixMagic()">âœ¨ Auto-Mix Magic</button>
      </div>
      <label style="color: #ffd700;">Master Volume:</label>
      <input type="range" id="masterVolume" min="0" max="100" value="75" oninput="setMasterVolume(this.value)" style="width: 100%; margin: 10px 0;">
      <div class="status" id="mixerStatus">
        ğŸš Mixing Console: OPERATIONAL<br>
        ğŸ”Š Tracks: 4 (Default)<br>
        ğŸ› Master Volume: 75%<br>
        âš¡ Each track has: Volume, Pan, EQ, Solo, Mute<br>
        ğŸŒŸ Professional-grade mixing capabilities!
      </div>
    </div>
  </div>

  <!-- REAL-TIME COLLABORATION HUB -->
  <div class="module">
    <h2>ğŸ¤ Real-Time Collaboration Hub</h2>
    <div class="controls">
      <div class="control-row">
        <button class="btn" onclick="startCollabSession()">ğŸ¤ Start Session</button>
        <button class="btn" onclick="joinCosmicRoom()">ğŸŒŒ Join Room</button>
        <button class="btn" onclick="shareSession()">ğŸ“¤ Share Session</button>
        <button class="btn" onclick="inviteCollaborators()">ğŸ‘¥ Invite Users</button>
      </div>
      <div id="collaborationChat" class="status" style="height: 120px;">
        ğŸ¤ Collaboration Hub Ready<br>
        ğŸ’¬ Real-time chat enabled<br>
        ğŸµ Sync music sessions<br>
        ğŸŒŒ Connect with cosmic musicians worldwide!<br>
        <input type="text" id="chatInput" placeholder="Type message..." style="width: 100%; margin-top: 10px;" onkeypress="if(event.key==='Enter')sendChatMessage()">
      </div>
      <div class="status" id="collaborationStatus">
        ğŸ¤ Collaboration: READY<br>
        ğŸŒ WebRTC: Enabled<br>
        ğŸ’¬ Chat: Active<br>
        ğŸµ Session Sync: Available<br>
        ğŸ‘¥ Max Participants: 8
      </div>
    </div>
  </div>

  <!-- AI COSMIC ASSISTANT -->
  <div class="module">
    <h2>ğŸ¤– AI Cosmic Assistant</h2>
    <div class="controls">
      <div class="control-row">
        <button class="btn" onclick="getAISuggestion()">ğŸ’¡ Get Suggestion</button>
        <button class="btn" onclick="analyzeCurrentJam()">ğŸ“Š Analyze Jam</button>
        <button class="btn" onclick="generateChords()">ğŸ¼ Generate Chords</button>
        <button class="btn" onclick="aiCompose()">ğŸµ AI Compose</button>
      </div>
      <div id="aiResponse" class="prize-display" style="font-size: 14px; min-height: 80px;">
        ğŸ¤– AI Assistant Ready!<br>
        ğŸ’­ I can help with music theory, chord progressions, mixing tips, and creative inspiration.<br>
        ğŸµ Ask me anything about your cosmic musical journey!
      </div>
      <div class="status" id="aiStatus">
        ğŸ¤– AI Assistant: ONLINE<br>
        ğŸ§  Knowledge Base: Music Theory, Production, Mixing<br>
        ğŸµ Creative Mode: Active<br>
        ğŸ’« Cosmic Wisdom: Unlimited<br>
        âœ¨ Ready to enhance your musical creations!
      </div>
    </div>
  </div>

  <!-- ULTIMATE JAM MODES -->
  <div class="module">
    <h2>ğŸ¸ Ultimate Jam Modes</h2>
    <div class="controls">
      <div class="control-row">
        <button class="btn" onclick="ultimateCosmicJam()">ğŸŒŒ Ultimate Cosmic</button>
        <button class="btn" onclick="motownMasterJam()">ğŸµ Motown Master</button>
        <button class="btn" onclick="psychedelicOdyssey()">ğŸŒˆ Psychedelic Odyssey</button>
        <button class="btn" onclick="indianClassicalRaga()">ğŸ•‰ Raga Journey</button>
      </div>
      <div class="control-row">
        <button class="btn" onclick="africanPolyrhythm()">ğŸ¥ African Rhythms</button>
        <button class="btn" onclick="wreckingCrewSession()">ğŸ¸ Wrecking Crew</button>
        <button class="btn" onclick="reggaeVibesJam()">ğŸŒ´ Reggae Vibes</button>
        <button class="btn" onclick="stopAllJams()">ğŸ›‘ Stop All Jams</button>
      </div>
      <div class="status" id="jamStatus">
        ğŸ¸ Jam Modes: READY<br>
        ğŸµ 8 Professional Jam Styles Available<br>
        ğŸ¹ Auto-instruments and effects per style<br>
        ğŸŒŸ Each mode includes genre-specific UAD presets<br>
        ğŸš€ Keyboard shortcuts: J/M/Z/I/A/W/R for quick access!
      </div>
    </div>
  </div>

  <!-- MASTER CONTROL CENTER -->
  <div class="module">
    <h2>ğŸš Master Control Center</h2>
    <div class="controls">
      <div class="control-row">
        <button class="btn" onclick="saveCosmicSession()">ğŸ’¾ Save Session</button>
        <button class="btn" onclick="loadCosmicSession()">ğŸ“‚ Load Session</button>
        <button class="btn" onclick="exportEverything()">ğŸ“¤ Export All</button>
        <button class="btn" onclick="newCosmicSession()">ğŸ†• New Session</button>
      </div>
      <div class="control-row">
        <button class="btn" onclick="fullSystemBackup()">ğŸ”„ Full Backup</button>
        <button class="btn" onclick="performanceMode()">âš¡ Performance Mode</button>
        <button class="btn" onclick="lowPowerMode()">ğŸ”‹ Low Power</button>
        <button class="btn" onclick="ultimateEmergencyStop()">ğŸš¨ EMERGENCY</button>
      </div>
      <div class="status" id="masterStatus">
        ğŸš Master Control: OPERATIONAL<br>
        ğŸ’¾ Auto-Save: Enabled<br>
        ğŸ”„ System Health: Excellent<br>
        âš¡ Performance: Optimal<br>
        ğŸŒŸ All systems ready for cosmic creation!
      </div>
    </div>
  </div>

  <!-- COSMIC TREPANNING CONSOLE -->
  <div class="module">
    <h2>ğŸ’€ Cosmic Trepanning Console</h2>
    <div class="controls">
      <div class="control-row">
        <button class="btn" onclick="runFullSystemTest()">ğŸ§ª Full System Test</button>
        <button class="btn" onclick="booleanPortalCheck()">ğŸ” Boolean Check</button>
        <button class="btn" onclick="crisisProtocol()">ğŸš¨ Crisis Protocol</button>
        <button class="btn" onclick="mindPortalDiagnostics()">ğŸ§  Portal Diagnostics</button>
      </div>
      <div class="control-row">
        <button class="btn" onclick="clearAllLogs()">ğŸ§¹ Clear Logs</button>
        <button class="btn" onclick="debugModeToggle()">ğŸ› Debug Mode</button>
        <button class="btn" onclick="cosmicCalibration()">âš– Calibration</button>
        <button class="btn" onclick="quantumReset()">ğŸŒ€ Quantum Reset</button>
      </div>
      <div class="status" id="trepanConsole" style="height: 200px; font-size: 11px;">
        ğŸ’€ COSMIC TREPANNING CONSOLE v3.14159<br>
        ğŸŒŒ [SYSTEM] Monster Kozmic Casino COMPLETE EDITION initialized<br>
        ğŸƒ [JOKER] AI Supreme Collaboration: Claude + Grok active<br>
        ğŸ° [CASINO] All gaming systems operational<br>
        ğŸµ [AUDIO] Professional production suite ready<br>
        ğŸŒ [WEB3] Blockchain integration active<br>
        ğŸ’€ [TREPAN] Consciousness expansion protocols loaded<br>
        âœ¨ [STATUS] Ready for cosmic transcendence!<br>
      </div>
    </div>
  </div>
</div>

<!-- COSMIC CREATURE - ULTIMATE GUIDE -->
<div class="cosmic-creature" onclick="pulseCosmicCreature()" title="Click 5 times for ULTIMATE HYPERNOVA MODE!">
  ğŸ’€
</div>

<script>
// ====================================
// MONSTER KOZMIC CASINO COMPLETE EDITION
// Full Implementation - No Compromises
// ====================================

// SUPREME GLOBAL STATE
let audioContext, analyzer, masterGain, audioStream, mediaRecorder;
let scene, camera, renderer, particles, particleSystem;
let web3, cosmicContract, playerAddress, contractAddress;
let isRecording = false, isTrepanning = false, webglActive = false, isSpinning = false;
let currentGenre = 'standard', currentEffect = 'particles', trepanLevel = 5, intensity = 75;
let recordedTracks = [], mixerTracks = [], ctokBalance = 1000, mindPortals = 0, nftCount = 0;
let clickCount = 0, lastClick = 0, collaborationActive = false, aiActive = false;
let systemPerformance = 'optimal', debugMode = false, recordingStartTime = 0;

// ENHANCED COSMIC STATE MANAGEMENT
const KOZMIC_STATE = {
  audioConnected: false,
  portalOpen: false,
  trepanActive: false,
  web3Connected: false,
  recordingActive: false,
  jamModeActive: false,
  collaborationLive: false,
  webglRendering: false,
  slotMachineActive: true,
  chaosMode: false,
  hypernovaMode: false,
  aiAssistantOnline: false,
  systemHealth: 'excellent',
  cosmicAlignment: 'perfect'
};

// COMPREHENSIVE GENRE SYSTEM
const COSMIC_GENRES = {
  standard: {
    name: 'Standard', bpm: 120, key: 'C Major', scale: 'Major',
    instruments: ['Kick', 'Snare', 'Hi-Hat', 'Bass', 'Piano', 'Guitar', 'Organ', 'Strings'],
    color: '#4ecdc4', uadPreset: [0, 2]
  },
  motown: {
    name: 'Motown (Funk Brothers)', bpm: 110, key: 'F Major', scale: 'Major',
    instruments: ['Jamerson Bass', 'Benny Drums', 'Messina Guitar', 'Van Dyke Keys', 'Horns', 'Vocals', 'Tambourine', 'Claps'],
    color: '#ff6b35', uadPreset: [0, 1, 2],
    samples: { 'Jamerson Bass': 'bass_motown.wav', 'Benny Drums': 'drums_motown.wav' }
  },
  wrecking_crew: {
    name: 'Wrecking Crew (LA Studio)', bpm: 130, key: 'G Major', scale: 'Major',
    instruments: ['Kaye Bass', 'Blaine Drums', 'Tedesco Guitar', 'Knechtel Keys', 'Wall of Sound', 'Studio Magic', 'Spector Hall', 'Gold Star'],
    color: '#ffaa33', uadPreset: [1, 2, 4]
  },
  reggae: {
    name: 'Reggae Vibes', bpm: 85, key: 'A Minor', scale: 'Minor',
    instruments: ['Bass Drop', 'Skank Guitar', 'One Drop', 'Rim Shot', 'Organ Bubble', 'Melodica', 'Horns', 'Dub Delay'],
    color: '#00ff00', uadPreset: [2, 3]
  },
  psychedelic: {
    name: 'Psychedelic Rock', bpm: 140, key: 'E Mixolydian', scale: 'Mixolydian',
    instruments: ['Fuzz Bass', 'Wah Guitar', 'Reverse Cymbal', 'Phaser Drums', 'Mellotron', 'Sitar', 'Theremin', 'Cosmic Pad'],
    color: '#ff00ff', uadPreset: [3, 5, 7], effects: ['chorus', 'delay', 'reverb']
  },
  indian_classical: {
    name: 'Indian Classical', bpm: 90, key: 'D Raga', scale: 'Raga Yaman',
    instruments: ['Sitar', 'Tabla', 'Tanpura', 'Bansuri', 'Harmonium', 'Veena', 'Mridangam', 'Drone'],
    color: '#ff9900', microtonal: true,
    tuning: [261.63, 275.22, 294.33, 311.13, 329.63, 348.45, 370.99, 392.00]
  },
  african_polyrhythm: {
    name: 'African Polyrhythms', bpm: 100, key: 'Bb Pentatonic', scale: 'Pentatonic',
    instruments: ['Djembe', 'Kora', 'Balafon', 'Shekere', 'Dundun', 'Talking Drum', 'Kalimba', 'Ngoni'],
    color: '#ffaa00', polyrhythmic: true
  },
  cosmic_fusion: {
    name: 'Cosmic Fusion', bpm: 160, key: 'Omni-Dimensional', scale: 'Quantum',
    instruments: ['Quantum Synth', 'Plasma Drums', 'Laser Harp', 'Void Bass', 'Stellar Pad', 'Cosmic Wind', 'Black Hole', 'Supernova'],
    color: '#00ffff', experimental: true, uadPreset: [0, 1, 2, 3, 4, 5]
  }
};

// PROFESSIONAL UAD PLUGIN SYSTEM
const UAD_PLUGINS = [
  { name: 'LA-2A Leveler', type: 'compressor', value: 0.5, active: false, node: null, bypass: false },
  { name: '1176 FET', type: 'compressor', value: 0.6, active: false, node: null, bypass: false },
  { name: 'Lexicon 224', type: 'reverb', value: 0.4, active: false, node: null, bypass: false },
  { name: 'Galaxy Delay', type: 'delay', value: 0.3, active: false, node: null, bypass: false },
  { name: 'Pultec EQ', type: 'eq', value: 0.5, active: false, node: null, bypass: false },
  { name: 'Ruby Amp', type: 'amp', value: 0.7, active: false, node: null, bypass: false },
  { name: 'Verve Tape', type: 'tape', value: 0.4, active: false, node: null, bypass: false },
  { name: 'Brigade Chorus', type: 'chorus', value: 0.3, active: false, node: null, bypass: false },
  { name: 'Opal Synth', type: 'synth', value: 0.6, active: false, node: null, bypass: false },
  { name: 'Hitsville Chamber', type: 'chamber', value: 0.5, active: false, node: null, bypass: false },
  { name: 'Trepan Portal', type: 'trepan', value: 0.8, active: false, node: null, bypass: false },
  { name: 'Cosmic Distortion', type: 'distortion', value: 0.4, active: false, node: null, bypass: false }
];

// COSMIC SLOT MACHINE SYSTEM
const SLOT_SYMBOLS = ['ğŸ¸', 'ğŸ¹', 'ğŸ’€', 'ğŸŒŸ', 'ğŸƒ'];
const COSMIC_PRIZES = {
  'ğŸ¸ğŸ¸ğŸ¸': { type: 'instrument', value: 'Cosmic Guitar', reward: 1000, message: 'ğŸ¸ LEGENDARY COSMIC GUITAR UNLOCKED! +1000 CTOK! ğŸ¸' },
  'ğŸ¹ğŸ¹ğŸ¹': { type: 'instrument', value: 'Quantum Piano', reward: 1000, message: 'ğŸ¹ QUANTUM PIANO MATERIALIZED! +1000 CTOK! ğŸ¹' },
  'ğŸ’€ğŸ’€ğŸ’€': { type: 'effect', value: 'Death Metal Portal', reward: 1500, message: 'ğŸ’€ DEATH METAL PORTAL OPENED! +1500 CTOK! ğŸ’€' },
  'ğŸŒŸğŸŒŸğŸŒŸ': { type: 'effect', value: 'Supernova Reverb', reward: 2000, message: 'ğŸŒŸ SUPERNOVA REVERB ACTIVATED! +2000 CTOK! ğŸŒŸ' },
  'ğŸƒğŸƒğŸƒ': { type: 'nft', value: 'Ultimate Kwepie NFT', reward: 10000, message: 'ğŸƒ ULTIMATE KWEPIE NFT JACKPOT! +10000 CTOK! ğŸƒ' },
  'double_joker': { type: 'ctok', value: 500, reward: 500, message: 'ğŸƒ JOKER POWER! +500 CTOK! ğŸƒ' },
  'triple_mixed': { type: 'bonus', value: 'chaos', reward: 0, message: 'ğŸŒ€ COSMIC CHAOS UNLEASHED! REALITY BENDS! ğŸŒ€' },
  'supernova_joker': { type: 'freespin', value: 3, reward: 0, message: 'ğŸŒŸğŸƒ COSMIC ALIGNMENT! 3 FREE SPINS! ğŸƒğŸŒŸ' }
};

// WEB3 CONTRACT CONFIGURATION
const CONTRACT_CONFIG = {
  address: '0x742d35Cc6634C0532925a3b8D5C0cE5eF5f6a8b7',
  abi: [
    {
      "inputs": [{"type": "string", "name": "tokenURI"}],
      "name": "mintCosmicNFT",
      "outputs": [{"type": "uint256", "name": "tokenId"}],
      "type": "function"
    },
    {
      "inputs": [{"type": "address", "name": "user"}, {"type": "uint256", "name": "amount"}],
      "name": "awardCTOK",
      "outputs": [{"type": "bool"}],
      "type": "function"
    }
  ],
  chainId: 137,
  rpcUrl: 'https://polygon-rpc.com'
};

// ====================================
// INITIALIZATION SYSTEM
// ====================================
document.addEventListener('DOMContentLoaded', function() {
  console.log('ğŸŒŒğŸ° MONSTER KOZMIC CASINO COMPLETE EDITION LOADING... ğŸ°ğŸŒŒ');
  
  try {
    // Initialize core systems immediately
    initializeCosmicSystems();
    logTrepanMessage('ğŸŒŒ All cosmic systems initialized successfully!', 'success');
  } catch (error) {
    console.error('Initialization error:', error);
    logTrepanMessage('ğŸš¨ CRITICAL: Initialization failed: ' + error.message, 'error');
  }
});

function initializeCosmicSystems() {
  // Initialize WebGL Portal
  initWebGLPortal();
  
  // Initialize Audio Systems
  prepareAudioContext();
  
  // Initialize Genre Wheel
  initGenreWheel();
  
  // Initialize UAD Fortress
  initUADFortress();
  
  // Initialize Mixer Console
  initMixerConsole();
  
  // Initialize Slot Machine
  initCosmicSlotMachine();
  
  // Initialize AI Assistant
  initAIAssistant();
  
  // Initialize Spectrum Analyzer
  initSpectrumAnalyzer();
  
  // Initialize Global Functions
  exposeGlobalFunctions();
  
  // Initialize Keyboard Shortcuts
  initKeyboardShortcuts();
  
  // Set up event listeners
  setupEventListeners();
  
  // Auto-run startup sequence
  setTimeout(() => {
    cosmicStartupSequence();
  }, 1000);
}

function cosmicStartupSequence() {
  const messages = [
    'ğŸ° MONSTER KOZMIC CASINO COMPLETE EDITION ONLINE!',
    'ğŸƒ AI JOKER SUPREME COLLABORATION: Claude + Grok ACTIVE!',
    'ğŸŒŒ All cosmic systems operational and ready!',
    'ğŸ² Slot machine ready for ultimate jackpots!',
    'ğŸµ Professional music production suite loaded!',
    'ğŸŒ Web3 casino features enabled!',
    'ğŸ’€ Consciousness expansion protocols ready!',
    'âœ¨ Welcome to the ultimate cosmic experience!'
  ];
  
  messages.forEach((msg, index) => {
    setTimeout(() => {
      logTrepanMessage(msg, index === 0 ? 'error' : 'success');
    }, index * 800);
  });
  
  // Auto-run system test
  setTimeout(() => {
    logTrepanMessage('ğŸ§ª Running automatic system diagnostics...', 'info');
    runFullSystemTest();
  }, 8000);
}

// ====================================
// WEBGL PORTAL SYSTEM
// ====================================
function initWebGLPortal() {
  try {
    const canvas = document.getElementById('webglCanvas');
    if (!canvas || !window.THREE) {
      logTrepanMessage('âš  WebGL not available, portal running in fallback mode', 'warning');
      return;
    }
    
    scene = new THREE.Scene();
    camera = new THREE.PerspectiveCamera(75, canvas.clientWidth / canvas.clientHeight, 0.1, 1000);
    renderer = new THREE.WebGLRenderer({ canvas, alpha: true, antialias: true });
    renderer.setSize(canvas.clientWidth, canvas.clientHeight);
    renderer.setPixelRatio(window.devicePixelRatio);
    camera.position.z = 8;
    
    webglActive = true;
    KOZMIC_STATE.webglRendering = true;
    
    createCosmicParticleSystem();
    animateWebGLPortal();
    
    document.getElementById('portalOverlay').textContent = 'Portal: WebGL Active';
    logTrepanMessage('ğŸŒŒ WebGL Portal initialized with advanced particle system', 'success');
  } catch (error) {
    logTrepanMessage('ğŸš¨ WebGL Portal initialization failed: ' + error.message, 'error');
    webglActive = false;
    KOZMIC_STATE.webglRendering = false;
  }
}

function createCosmicParticleSystem() {
  if (particles) scene.remove(particles);
  
  const geometry = new THREE.BufferGeometry();
  const positions = [];
  const colors = [];
  const sizes = [];
  const particleCount = intensity * 3; // Reduced for performance
  
  for (let i = 0; i < particleCount; i++) {
    // Positions in a cosmic spiral
    const theta = (i / particleCount) * Math.PI * 4;
    const radius = 2 + Math.random() * 6;
    positions.push(
      Math.cos(theta) * radius + (Math.random() - 0.5) * 2,
      Math.sin(theta) * radius + (Math.random() - 0.5) * 2,
      (Math.random() - 0.5) * 8
    );
    
    // Dynamic colors based on cosmic state
    if (KOZMIC_STATE.chaosMode) {
      colors.push(Math.random(), Math.random(), Math.random());
    } else if (KOZMIC_STATE.hypernovaMode) {
      colors.push(1, 0.5 + Math.random() * 0.5, 0);
    } else {
      colors.push(
        0.2 + Math.random() * 0.8,
        0.5 + Math.random() * 0.5,
        0.8 + Math.random() * 0.2
      );
    }
    
    sizes.push(0.5 + Math.random() * 2);
  }
  
  geometry.setAttribute('position', new THREE.Float32BufferAttribute(positions, 3));
  geometry.setAttribute('color', new THREE.Float32BufferAttribute(colors, 3));
  geometry.setAttribute('size', new THREE.Float32BufferAttribute(sizes, 1));
  
  const material = new THREE.PointsMaterial({
    size: 0.1,
    vertexColors: true,
    transparent: true,
    opacity: 0.8,
    blending: THREE.AdditiveBlending
  });
  
  particles = new THREE.Points(geometry, material);
  scene.add(particles);
}

function animateWebGLPortal() {
  if (!webglActive) return;
  requestAnimationFrame(animateWebGLPortal);
  
  if (particles) {
    // Base rotation
    particles.rotation.x += 0.002;
    particles.rotation.y += 0.003;
    
    // Chaos mode effects
    if (KOZMIC_STATE.chaosMode) {
      particles.rotation.z += 0.05;
      particles.scale.setScalar(1 + Math.sin(Date.now() * 0.01) * 0.5);
    }
    
    // Hypernova mode effects
    if (KOZMIC_STATE.hypernovaMode) {
      particles.rotation.x += 0.1;
      particles.rotation.y += 0.1;
      particles.scale.setScalar(1 + Math.sin(Date.now() * 0.02) * 1);
    }
    
    // Trepanning mode effects
    if (KOZMIC_STATE.trepanActive) {
      const time = Date.now() * 0.005;
      particles.position.x = Math.sin(time) * 0.5;
      particles.position.y = Math.cos(time) * 0.3;
    }
    
    // Audio-reactive effects
    if (analyzer && KOZMIC_STATE.audioConnected) {
      const dataArray = new Uint8Array(analyzer.frequencyBinCount);
      analyzer.getByteFrequencyData(dataArray);
      const avgFreq = dataArray.reduce((a, b) => a + b) / dataArray.length;
      particles.scale.setScalar(1 + (avgFreq / 255) * 0.5);
    }
  }
  
  renderer.render(scene, camera);
}

// ====================================
// AUDIO PORTAL SYSTEM
// ====================================
function prepareAudioContext() {
  // Prepare for user interaction
  document.addEventListener('click', () => {
    if (!audioContext) {
      audioContext = new (window.AudioContext || window.webkitAudioContext)();
      masterGain = audioContext.createGain();
      masterGain.connect(audioContext.destination);
      masterGain.gain.value = 0.75;
      
      analyzer = audioContext.createAnalyser();
      analyzer.fftSize = 2048;
      masterGain.connect(analyzer);
      
      logTrepanMessage('ğŸ”Š Audio context created on user interaction', 'success');
    }
  }, { once: true });
}

function openCosmicPortal() {
  try {
    if (!audioContext) {
      audioContext = new (window.AudioContext || window.webkitAudioContext)();
      masterGain = audioContext.createGain();
      masterGain.connect(audioContext.destination);
      analyzer = audioContext.createAnalyser();
      analyzer.fftSize = 2048;
      masterGain.connect(analyzer);
    }
    
    navigator.mediaDevices.getUserMedia({
      audio: {
        echoCancellation: false,
        noiseSuppression: false,
        autoGainControl: false,
        sampleRate: 44100
      }
    }).then(stream => {
      audioStream = stream;
      const source = audioContext.createMediaStreamSource(stream);
      source.connect(masterGain);
      
      KOZMIC_STATE.audioConnected = true;
      KOZMIC_STATE.portalOpen = true;
      
      document.getElementById('portalOverlay').textContent = 'Portal: ACTIVE';
      updatePortalStatus('ğŸŒ€ Cosmic Portal OPENED! Audio flowing through dimensions...');
      startAudioVisualization();
      
      logTrepanMessage('ğŸŒ€ Cosmic Portal opened successfully! Audio streaming active.', 'success');
    }).catch(error => {
      logTrepanMessage('ğŸš¨ Portal opening failed: ' + error.message, 'error');
      updatePortalStatus('âŒ Portal connection failed! Check microphone permissions.');
    });
  } catch (error) {
    logTrepanMessage('ğŸš¨ Portal initialization error: ' + error.message, 'error');
  }
}

function startAudioVisualization() {
  if (!analyzer) return;
  
  const bufferLength = analyzer.frequencyBinCount;
  const dataArray = new Uint8Array(bufferLength);
  
  function visualize() {
    if (!KOZMIC_STATE.portalOpen) return;
    
    analyzer.getByteFrequencyData(dataArray);
    
    // Update portal status with audio level
    const avgLevel = dataArray.reduce((a, b) => a + b) / bufferLength;
    const levelPercent = Math.round((avgLevel / 255) * 100);
    
    updatePortalStatus(`ğŸŒ€ Portal Active | Audio Level: ${levelPercent}% | Trepan: ${trepanLevel}/10`);
    
    requestAnimationFrame(visualize);
  }
  visualize();
}

function updatePortalStatus(message) {
  document.getElementById('portalStatus').innerHTML = message;
}

// ====================================
// COSMIC SLOT MACHINE SYSTEM
// ====================================
function initCosmicSlotMachine() {
  updateSlotStatus('ğŸ° Cosmic Slot Machine initialized and ready for ultimate jackpots!');
  updateCosmicBalance();
}

function spinCosmicSlots() {
  if (isSpinning) {
    logTrepanMessage('ğŸ° Cosmic reels already spinning! Please wait...', 'warning');
    return;
  }
  
  if (ctokBalance < 50) {
    logTrepanMessage('ğŸš¨ Need 50 CTOK to spin! Use God Mode or earn more CTOK!', 'error');
    showCosmicPrize('ğŸ’¸ Insufficient CTOK! Need 50 to spin the cosmic reels.');
    return;
  }
  
  // Deduct spin cost
  ctokBalance -= 50;
  isSpinning = true;
  updateCosmicBalance();
  
  const reels = [
    document.getElementById('reel1'),
    document.getElementById('reel2'),
    document.getElementById('reel3')
  ];
  
  const spinBtn = document.getElementById('cosmicSpinBtn');
  spinBtn.classList.add('disabled');
  spinBtn.textContent = 'ğŸ² SPINNING COSMIC REELS... ğŸ²';
  
  logTrepanMessage('ğŸ° Spinning cosmic reels... 50 CTOK sacrificed to the void!', 'info');
  updateSlotStatus('ğŸ² COSMIC REELS SPINNING! Reality bending in progress...');
  
  // Start epic spinning animation
  reels.forEach((reel, index) => {
    reel.classList.add('spinning');
    // Rapidly change symbols during spin
    let spinCount = 0;
    const spinInterval = setInterval(() => {
      reel.textContent = SLOT_SYMBOLS[Math.floor(Math.random() * SLOT_SYMBOLS.length)];
      spinCount++;
      if (spinCount > 30) clearInterval(spinInterval);
    }, 100);
  });
  
  playCosmicSound('slot_spin');
  
  // Generate results with weighted probabilities
  const results = generateWeightedResults();
  
  // Stop reels dramatically
  setTimeout(() => stopCosmicReel(reels[0], results[0], 0), 1500);
  setTimeout(() => stopCosmicReel(reels[1], results[1], 1), 2200);
  setTimeout(() => stopCosmicReel(reels[2], results[2], 2), 3000);
  
  // Check results and award prizes
  setTimeout(() => {
    evaluateCosmicResults(results, reels);
    
    // Reset spin button
    isSpinning = false;
    spinBtn.classList.remove('disabled');
    spinBtn.textContent = 'ğŸ² SPIN COSMIC REELS (50 CTOK) ğŸ²';
    
    // Remove visual effects
    setTimeout(() => {
      reels.forEach(reel => {
        reel.classList.remove('winner', 'jackpot');
      });
    }, 5000);
  }, 4000);
}

function generateWeightedResults() {
  // Weighted probability system for more realistic casino experience
  const weights = {
    'ğŸ¸': 25, // 25% chance
    'ğŸ¹': 25, // 25% chance
    'ğŸ’€': 20, // 20% chance
    'ğŸŒŸ': 15, // 15% chance
    'ğŸƒ': 15  // 15% chance (joker is special)
  };
  
  function weightedRandom() {
    const totalWeight = Object.values(weights).reduce((a, b) => a + b, 0);
    let random = Math.random() * totalWeight;
    
    for (const [symbol, weight] of Object.entries(weights)) {
      random -= weight;
      if (random <= 0) return symbol;
    }
    return 'ğŸ¸'; // fallback
  }
  
  return [weightedRandom(), weightedRandom(), weightedRandom()];
}

function stopCosmicReel(reel, symbol, index) {
  reel.classList.remove('spinning');
  reel.textContent = symbol;
  playCosmicSound('reel_stop');
  
  // Visual feedback
  reel.style.transform = 'scale(1.2)';
  setTimeout(() => reel.style.transform = '', 400);
}

function evaluateCosmicResults(results, reels) {
  const [r1, r2, r3] = results;
  const resultKey = `${r1}${r2}${r3}`;
  
  logTrepanMessage(`ğŸ° Cosmic Results: ${r1} ${r2} ${r3}`, 'info');
  
  // Check for exact matches first
  if (COSMIC_PRIZES[resultKey]) {
    awardCosmicPrize(COSMIC_PRIZES[resultKey], reels, 'exact');
    return;
  }
  
  // Check for three of a kind
  if (r1 === r2 && r2 === r3) {
    awardCosmicPrize(COSMIC_PRIZES[resultKey] || {
      type: 'bonus', reward: 1000,
      message: `ğŸ‰ TRIPLE ${r1}! Cosmic alignment achieved! +1000 CTOK! ğŸ‰`
    }, reels, 'triple');
    return;
  }
  
  // Check for joker combinations
  const jokerCount = results.filter(r => r === 'ğŸƒ').length;
  if (jokerCount >= 2) {
    awardCosmicPrize(COSMIC_PRIZES['double_joker'], reels, 'joker');
    return;
  }
  
  if (jokerCount === 1) {
    // Single joker bonus
    awardCosmicPrize({
      type: 'ctok', reward: 100,
      message: 'ğŸƒ JOKER POWER! Wild card energy +100 CTOK! ğŸƒ'
    }, reels, 'single_joker');
    return;
  }
  
  // Check for two pairs
  if ((r1 === r2 || r1 === r3 || r2 === r3)) {
    awardCosmicPrize({
      type: 'ctok', reward: 50,
      message: 'ğŸ² DOUBLE SYMBOLS! Small cosmic win +50 CTOK! ğŸ²'
    }, reels, 'pair');
    return;
  }
  
  // No win
  showCosmicPrize('ğŸ’« The cosmos shifts... No alignment this time. Spin again to bend reality!');
  updateSlotStatus('ğŸ° No cosmic alignment... The universe demands another sacrifice!');
  playCosmicSound('no_win');
  logTrepanMessage('ğŸ’« No win this spin. The cosmic forces require more offerings.', 'warning');
}

function awardCosmicPrize(prize, reels, winType) {
  showCosmicPrize(prize.message);
  
  // Add visual effects based on win type
  switch (winType) {
    case 'exact':
    case 'triple':
      reels.forEach(reel => reel.classList.add('winner'));
      if (prize.type === 'nft') {
        reels.forEach(reel => reel.classList.add('jackpot'));
        triggerUltimateJackpot();
      }
      playCosmicSound('big_win');
      break;
    case 'joker':
      reels.filter(reel => reel.textContent === 'ğŸƒ').forEach(reel => reel.classList.add('winner'));
      playCosmicSound('joker_win');
      break;
    default:
      playCosmicSound('small_win');
  }
  
  // Award the prize
  ctokBalance += prize.reward || 0;
  
  switch (prize.type) {
    case 'instrument':
      COSMIC_GENRES[currentGenre].instruments.push(prize.value);
      initGenreWheel();
      logTrepanMessage(`ğŸµ ${prize.value} added to ${currentGenre} genre arsenal!`, 'success');
      break;
    case 'effect':
      UAD_PLUGINS.push({
        name: prize.value,
        type: 'cosmic',
        value: 0.8,
        active: true,
        node: null,
        bypass: false
      });
      initUADFortress();
      logTrepanMessage(`ğŸ› ${prize.value} materialized in UAD Fortress!`, 'success');
      break;
    case 'nft':
      mintCosmicNFT();
      nftCount++;
      updateAchievements();
      logTrepanMessage('ğŸ† ULTIMATE KWEPIE NFT MINTED! You are now a cosmic deity!', 'success');
      break;
    case 'bonus':
      if (prize.value === 'chaos') {
        activateCosmicChaos();
      }
      break;
    case 'freespin':
      logTrepanMessage(`ğŸ° ${prize.value} FREE SPINS granted by cosmic forces!`, 'success');
      setTimeout(() => {
        for (let i = 0; i < prize.value; i++) {
          setTimeout(() => {
            if (!isSpinning) spinCosmicSlots();
          }, i * 3000);
        }
      }, 2000);
      break;
  }
  
  updateCosmicBalance();
  updateSlotStatus(`ğŸ† COSMIC PRIZE AWARDED! ${prize.message}`);
  logTrepanMessage(prize.message, 'success');
}

function triggerUltimateJackpot() {
  // Screen flash effect
  const flash = document.createElement('div');
  flash.className = 'screen-flash';
  document.body.appendChild(flash);
  setTimeout(() => document.body.removeChild(flash), 500);
  
  // Cosmic creature celebration
  const creature = document.querySelector('.cosmic-creature');
  creature.textContent = 'ğŸ†';
  creature.style.animation = 'creatureFloat 0.5s infinite';
  
  // Activate chaos mode temporarily
  activateCosmicChaos();
  
  setTimeout(() => {
    creature.textContent = 'ğŸ’€';
    creature.style.animation = 'creatureFloat 4s ease-in-out infinite';
  }, 10000);
  
  logTrepanMessage('ğŸ† ULTIMATE JACKPOT CELEBRATION! Reality transcended!', 'error');
}

function showCosmicPrize(message) {
  const display = document.getElementById('cosmicPrizeDisplay');
  display.innerHTML = message;
  
  if (message.includes('JACKPOT') || message.includes('NFT')) {
    display.classList.add('jackpot');
    setTimeout(() => display.classList.remove('jackpot'), 5000);
  }
}

function updateCosmicBalance() {
  document.getElementById('cosmicBalance').textContent = `ğŸ’° CTOK: ${ctokBalance.toLocaleString()}`;
}

function updateSlotStatus(message) {
  const timestamp = new Date().toLocaleTimeString();
  document.getElementById('slotStatus').innerHTML = `ğŸ° [${timestamp}] ${message}`;
}

// Test functions for individual reels
function testReel(reelNum) {
  const reel = document.getElementById(`reel${reelNum}`);
  const randomSymbol = SLOT_SYMBOLS[Math.floor(Math.random() * SLOT_SYMBOLS.length)];
  reel.textContent = randomSymbol;
  reel.style.transform = 'scale(1.3)';
  setTimeout(() => reel.style.transform = '', 300);
  playCosmicSound('reel_click');
  logTrepanMessage(`ğŸ² Reel ${reelNum} manually set to ${randomSymbol}`, 'info');
}

function testUltimateJackpot() {
  document.getElementById('reel1').textContent = 'ğŸƒ';
  document.getElementById('reel2').textContent = 'ğŸƒ';
  document.getElementById('reel3').textContent = 'ğŸƒ';
  
  const reels = [
    document.getElementById('reel1'),
    document.getElementById('reel2'),
    document.getElementById('reel3')
  ];
  
  awardCosmicPrize(COSMIC_PRIZES['ğŸƒğŸƒğŸƒ'], reels, 'exact');
  logTrepanMessage('ğŸƒ ULTIMATE JACKPOT TEST ACTIVATED!', 'error');
}

function addCosmicCTOK() {
  ctokBalance += 1000;
  updateCosmicBalance();
  playCosmicSound('bonus');
  logTrepanMessage('ğŸ’° +1000 CTOK added! Ready for more cosmic spins!', 'success');
}

// ====================================
// AUDIO SYSTEM
// ====================================
function playCosmicSound(type) {
  if (!audioContext) return;
  
  try {
    const oscillator = audioContext.createOscillator();
    const gainNode = audioContext.createGain();
    
    switch (type) {
      case 'slot_spin':
        oscillator.type = 'sawtooth';
        oscillator.frequency.setValueAtTime(220, audioContext.currentTime);
        oscillator.frequency.exponentialRampToValueAtTime(880, audioContext.currentTime + 2);
        gainNode.gain.setValueAtTime(0.1, audioContext.currentTime);
        gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 2);
        break;
      case 'reel_stop':
        oscillator.type = 'sine';
        oscillator.frequency.setValueAtTime(660, audioContext.currentTime);
        gainNode.gain.setValueAtTime(0.15, audioContext.currentTime);
        gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.3);
        break;
      case 'big_win':
        oscillator.type = 'sine';
        oscillator.frequency.setValueAtTime(880, audioContext.currentTime);
        oscillator.frequency.setValueAtTime(1100, audioContext.currentTime + 0.2);
        oscillator.frequency.setValueAtTime(1320, audioContext.currentTime + 0.4);
        gainNode.gain.setValueAtTime(0.2, audioContext.currentTime);
        gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 1);
        break;
      case 'joker_win':
        oscillator.type = 'triangle';
        oscillator.frequency.setValueAtTime(440, audioContext.currentTime);
        oscillator.frequency.setValueAtTime(880, audioContext.currentTime + 0.1);
        oscillator.frequency.setValueAtTime(440, audioContext.currentTime + 0.2);
        gainNode.gain.setValueAtTime(0.15, audioContext.currentTime);
        gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.6);
        break;
      case 'small_win':
        oscillator.type = 'sine';
        oscillator.frequency.setValueAtTime(550, audioContext.currentTime);
        gainNode.gain.setValueAtTime(0.1, audioContext.currentTime);
        gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.4);
        break;
      case 'no_win':
        oscillator.type = 'sawtooth';
        oscillator.frequency.setValueAtTime(220, audioContext.currentTime);
        oscillator.frequency.exponentialRampToValueAtTime(110, audioContext.currentTime + 0.8);
        gainNode.gain.setValueAtTime(0.08, audioContext.currentTime);
        gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.8);
        break;
      case 'reel_click':
        oscillator.type = 'square';
        oscillator.frequency.setValueAtTime(800, audioContext.currentTime);
        gainNode.gain.setValueAtTime(0.1, audioContext.currentTime);
        gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.1);
        break;
      case 'bonus':
        oscillator.type = 'sine';
        oscillator.frequency.setValueAtTime(1000, audioContext.currentTime);
        gainNode.gain.setValueAtTime(0.15, audioContext.currentTime);
        gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.5);
        break;
      default:
        oscillator.type = 'sine';
        oscillator.frequency.setValueAtTime(440, audioContext.currentTime);
        gainNode.gain.setValueAtTime(0.1, audioContext.currentTime);
        gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.3);
    }
    
    oscillator.connect(gainNode);
    gainNode.connect(masterGain);
    oscillator.start();
    oscillator.stop(audioContext.currentTime + 2);
  } catch (error) {
    console.log('Audio playback error:', error);
  }
}

// ====================================
// GENRE WHEEL SYSTEM
// ====================================
function initGenreWheel() {
  try {
    populateInstrumentGrid();
    updateGenreInfo();
    logTrepanMessage('ğŸ² Genre Wheel initialized with cosmic instruments', 'success');
  } catch (error) {
    logTrepanMessage('ğŸš¨ Genre Wheel initialization failed: ' + error.message, 'error');
  }
}

function populateInstrumentGrid() {
  const grid = document.getElementById('instrumentGrid');
  grid.innerHTML = '';
  
  const genreData = COSMIC_GENRES[currentGenre];
  if (!genreData) return;
  
  genreData.instruments.forEach((instrument, index) => {
    const btn = document.createElement('button');
    btn.className = 'btn';
    btn.textContent = instrument;
    btn.onclick = () => playCosmicInstrument(index, instrument);
    btn.title = `Press ${index} to play ${instrument}`;
    btn.style.background = `linear-gradient(135deg, ${genreData.color}, #4ecdc4)`;
    grid.appendChild(btn);
  });
}

function updateGenreInfo() {
  const genreData = COSMIC_GENRES[currentGenre];
  if (!genreData) return;
  
  document.getElementById('genreInfo').innerHTML = 
    `ğŸµ ${genreData.name} | BPM: ${genreData.bpm} | Key: ${genreData.key} | Scale: ${genreData.scale}`;
  
  document.getElementById('genreStatus').innerHTML = `
    ğŸ² Genre: ${genreData.name}<br>
    ğŸµ Instruments: ${genreData.instruments.length}<br>
    ğŸ¼ BPM: ${genreData.bpm} | Key: ${genreData.key}<br>
    ğŸŒŸ Special Features: ${genreData.microtonal ? 'Microtonal' : 
                          genreData.polyrhythmic ? 'Polyrhythmic' : 
                          genreData.experimental ? 'Experimental' : 'Standard'}
  `;
}

function changeCosmicGenre() {
  try {
    const select = document.getElementById('genreSelect');
    currentGenre = select.value;
    initGenreWheel();
    logTrepanMessage(`ğŸ² Genre shifted to ${COSMIC_GENRES[currentGenre].name}!`, 'success');
    playCosmicSound('bonus');
  } catch (error) {
    logTrepanMessage('ğŸš¨ Genre change error: ' + error.message, 'error');
  }
}

function playCosmicInstrument(index, instrument) {
  if (!audioContext) {
    logTrepanMessage('ğŸš¨ Open Cosmic Portal first to play instruments!', 'error');
    return;
  }
  
  try {
    const genreData = COSMIC_GENRES[currentGenre];
    const oscillator = audioContext.createOscillator();
    const gainNode = audioContext.createGain();
    
    // Base frequencies for instruments
    const baseFrequencies = [130.81, 146.83, 164.81, 174.61, 196.00, 220.00, 246.94, 261.63];
    let frequency = baseFrequencies[index % baseFrequencies.length];
    
    // Genre-specific modifications
    switch (currentGenre) {
      case 'indian_classical':
        if (genreData.tuning) {
          frequency = genreData.tuning[index % genreData.tuning.length];
        }
        frequency *= 1.0594630943592953 ** (Math.random() * 0.25); // Microtonal variation
        oscillator.type = 'triangle';
        break;
      case 'psychedelic':
        oscillator.type = 'sawtooth';
        frequency *= (1 + Math.sin(Date.now() * 0.01) * 0.1); // Wobble effect
        break;
      case 'african_polyrhythm':
        oscillator.type = 'triangle';
        frequency *= 0.8; // Lower register
        break;
      case 'cosmic_fusion':
        oscillator.type = 'square';
        frequency *= (0.5 + Math.random() * 1.5); // Random frequency modulation
        break;
      case 'motown':
        oscillator.type = 'sine';
        frequency *= 1.2; // Brighter tone
        break;
      default:
        oscillator.type = 'sine';
    }
    
    oscillator.frequency.setValueAtTime(frequency, audioContext.currentTime);
    gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
    gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.8);
    
    oscillator.connect(gainNode);
    gainNode.connect(masterGain);
    oscillator.start();
    oscillator.stop(audioContext.currentTime + 0.8);
    
    logTrepanMessage(`ğŸµ ${instrument} played in ${genreData.name} style`, 'info');
  } catch (error) {
    logTrepanMessage('ğŸš¨ Instrument play error: ' + error.message, 'error');
  }
}

// ====================================
// UAD PLUGIN FORTRESS SYSTEM
// ====================================
function initUADFortress() {
  try {
    populateUADRack();
    logTrepanMessage('ğŸ› UAD Plugin Fortress operational with professional plugins', 'success');
  } catch (error) {
    logTrepanMessage('ğŸš¨ UAD Fortress initialization failed: ' + error.message, 'error');
  }
}

function populateUADRack() {
  const rack = document.getElementById('uadRack');
  rack.innerHTML = '';
  
  UAD_PLUGINS.forEach((plugin, index) => {
    const btn = document.createElement('button');
    const status = plugin.active ? (plugin.bypass ? 'BYPASS' : 'ON') : 'OFF';
    btn.className = plugin.active ? (plugin.bypass ? 'btn' : 'btn active') : 'btn';
    btn.textContent = `${plugin.name} (${status})`;
    btn.onclick = () => toggleUADPlugin(index);
    btn.oncontextmenu = (e) => {
      e.preventDefault();
      bypassUADPlugin(index);
    };
    btn.title = `${plugin.type.toUpperCase()} - Left: Toggle On/Off, Right: Bypass`;
    rack.appendChild(btn);
  });
  
  updateUADStatus();
}

function toggleUADPlugin(index) {
  try {
    const plugin = UAD_PLUGINS[index];
    plugin.active = !plugin.active;
    
    if (plugin.active && audioContext) {
      createUADNode(plugin);
    } else if (plugin.node) {
      plugin.node.disconnect();
      plugin.node = null;
    }
    
    populateUADRack();
    logTrepanMessage(`ğŸ› ${plugin.name} ${plugin.active ? 'activated' : 'deactivated'}`, 'info');
    playCosmicSound('reel_click');
  } catch (error) {
    logTrepanMessage('ğŸš¨ Plugin toggle error: ' + error.message, 'error');
  }
}

function bypassUADPlugin(index) {
  try {
    const plugin = UAD_PLUGINS[index];
    if (!plugin.active) return;
    
    plugin.bypass = !plugin.bypass;
    populateUADRack();
    logTrepanMessage(`ğŸ› ${plugin.name} ${plugin.bypass ? 'bypassed' : 'activated'}`, 'info');
  } catch (error) {
    logTrepanMessage('ğŸš¨ Plugin bypass error: ' + error.message, 'error');
  }
}

function createUADNode(plugin) {
  if (!audioContext) return;
  
  try {
    switch (plugin.type) {
      case 'compressor':
        plugin.node = audioContext.createDynamicsCompressor();
        plugin.node.threshold.value = -24;
        plugin.node.knee.value = 30;
        plugin.node.ratio.value = 12;
        plugin.node.attack.value = 0.003;
        plugin.node.release.value = 0.25;
        break;
      case 'reverb':
        plugin.node = audioContext.createConvolver();
        // Create impulse response for reverb
        const length = audioContext.sampleRate * 2;
        const impulse = audioContext.createBuffer(2, length, audioContext.sampleRate);
        for (let channel = 0; channel < 2; channel++) {
          const channelData = impulse.getChannelData(channel);
          for (let i = 0; i < length; i++) {
            channelData[i] = (Math.random() * 2 - 1) * Math.pow(1 - i / length, 2);
          }
        }
        plugin.node.buffer = impulse;
        break;
      case 'delay':
        plugin.node = audioContext.createDelay(1);
        plugin.node.delayTime.value = plugin.value * 0.5;
        break;
      case 'eq':
        plugin.node = audioContext.createBiquadFilter();
        plugin.node.type = 'peaking';
        plugin.node.frequency.value = 1000;
        plugin.node.Q.value = 1;
        plugin.node.gain.value = (plugin.value - 0.5) * 24;
        break;
      default:
        plugin.node = audioContext.createGain();
        plugin.node.gain.value = plugin.value;
    }
    
    if (masterGain && plugin.node) {
      plugin.node.connect(masterGain);
    }
  } catch (error) {
    console.error('UAD node creation error:', error);
  }
}

function loadUADPresets() {
  try {
    const genreData = COSMIC_GENRES[currentGenre];
    if (!genreData.uadPreset) return;
    
    // Reset all plugins first
    resetAllPlugins();
    
    // Activate preset plugins
    genreData.uadPreset.forEach(index => {
      if (UAD_PLUGINS[index]) {
        UAD_PLUGINS[index].active = true;
        UAD_PLUGINS[index].value = 0.7;
        if (audioContext) {
          createUADNode(UAD_PLUGINS[index]);
        }
      }
    });
    
    populateUADRack();
    logTrepanMessage(`ğŸ› ${genreData.name} UAD preset loaded`, 'success');
    playCosmicSound('bonus');
  } catch (error) {
    logTrepanMessage('ğŸš¨ Preset loading error: ' + error.message, 'error');
  }
}

function resetAllPlugins() {
  try {
    UAD_PLUGINS.forEach(plugin => {
      plugin.active = false;
      plugin.bypass = false;
      plugin.value = 0.5;
      if (plugin.node) {
        plugin.node.disconnect();
        plugin.node = null;
      }
    });
    populateUADRack();
    logTrepanMessage('ğŸ› All UAD plugins reset', 'info');
  } catch (error) {
    logTrepanMessage('ğŸš¨ Plugin reset error: ' + error.message, 'error');
  }
}

function bypassAllPlugins() {
  try {
    UAD_PLUGINS.forEach(plugin => {
      if (plugin.active) {
        plugin.bypass = true;
      }
    });
    populateUADRack();
    logTrepanMessage('ğŸ› All active UAD plugins bypassed', 'info');
  } catch (error) {
    logTrepanMessage('ğŸš¨ Plugin bypass error: ' + error.message, 'error');
  }
}

function chaosPluginMode() {
  try {
    UAD_PLUGINS.forEach((plugin, index) => {
      plugin.active = Math.random() > 0.5;
      plugin.value = Math.random();
      plugin.bypass = Math.random() > 0.7;
      if (plugin.active && audioContext) {
        createUADNode(plugin);
      }
    });
    populateUADRack();
    logTrepanMessage('ğŸƒ CHAOS PLUGIN MODE! Random UAD configuration activated!', 'error');
    playCosmicSound('joker_win');
  } catch (error) {
    logTrepanMessage('ğŸš¨ Chaos plugin error: ' + error.message, 'error');
  }
}

function updateUADStatus() {
  const activeCount = UAD_PLUGINS.filter(p => p.active && !p.bypass).length;
  const bypassedCount = UAD_PLUGINS.filter(p => p.active && p.bypass).length;
  
  document.getElementById('uadStatus').innerHTML = `
    ğŸ› UAD Plugin Fortress: OPERATIONAL<br>
    ğŸ”§ Total Plugins: ${UAD_PLUGINS.length}<br>
    âš¡ Active: ${activeCount} | Bypassed: ${bypassedCount}<br>
    ğŸš Click: Toggle On/Off | Right-Click: Bypass<br>
    ğŸŒŸ Genre presets available!
  `;
}

// ====================================
// MIXER CONSOLE SYSTEM
// ====================================
function initMixerConsole() {
  try {
    createDefaultMixerTracks();
    logTrepanMessage('ğŸš Professional Mixing Console initialized', 'success');
  } catch (error) {
    logTrepanMessage('ğŸš¨ Mixer Console initialization failed: ' + error.message, 'error');
  }
}

function createDefaultMixerTracks() {
  mixerTracks = [
    { name: 'Master', volume: 75, pan: 0, eq: { low: 0, mid: 0, high: 0 }, solo: false, mute: false },
    { name: 'Input', volume: 80, pan: 0, eq: { low: 0, mid: 0, high: 0 }, solo: false, mute: false },
    { name: 'Drums', volume: 85, pan: 0, eq: { low: +2, mid: 0, high: +1 }, solo: false, mute: false },
    { name: 'Bass', volume: 75, pan: -10, eq: { low: +3, mid: -1, high: -2 }, solo: false, mute: false },
    { name: 'Guitar', volume: 70, pan: +15, eq: { low: -1, mid: +2, high: +3 }, solo: false, mute: false },
    { name: 'Keys', volume: 65, pan: -5, eq: { low: 0, mid: +1, high: +2 }, solo: false, mute: false }
  ];
  renderMixerTracks();
}

function renderMixerTracks() {
  const container = document.getElementById('mixerTracks');
  container.innerHTML = '';
  
  mixerTracks.forEach((track, index) => {
    const trackDiv = document.createElement('div');
    trackDiv.style.cssText = `
      background: rgba(44, 44, 78, 0.9);
      border: 2px solid #4ecdc4;
      border-radius: 10px;
      padding: 10px;
      text-align: center;
    `;
    
    trackDiv.innerHTML = `
      <h4 style="color: #ff6b9d; margin-bottom: 8px;">${track.name}</h4>
      <input type="range" min="0" max="100" value="${track.volume}" 
             onchange="updateTrackVolume(${index}, this.value)"
             style="width: 100%; margin: 5px 0;">
      <div style="font-size: 12px; color: #4ecdc4;">Vol: ${track.volume}%</div>
      <input type="range" min="-50" max="50" value="${track.pan}" 
             onchange="updateTrackPan(${index}, this.value)"
             style="width: 100%; margin: 5px 0;">
      <div style="font-size: 12px; color: #4ecdc4;">Pan: ${track.pan}</div>
      <div style="margin: 8px 0;">
        <button class="btn ${track.solo ? 'active' : ''}" style="padding: 4px 8px; margin: 2px; font-size: 10px;"
                onclick="toggleTrackSolo(${index})">S</button>
        <button class="btn ${track.mute ? 'active' : ''}" style="padding: 4px 8px; margin: 2px; font-size: 10px;"
                onclick="toggleTrackMute(${index})">M</button>
      </div>
    `;
    container.appendChild(trackDiv);
  });
}

function updateTrackVolume(trackIndex, volume) {
  mixerTracks[trackIndex].volume = parseInt(volume);
  renderMixerTracks();
  logTrepanMessage(`ğŸš ${mixerTracks[trackIndex].name} volume: ${volume}%`, 'info');
}

function updateTrackPan(trackIndex, pan) {
  mixerTracks[trackIndex].pan = parseInt(pan);
  renderMixerTracks();
  logTrepanMessage(`ğŸš ${mixerTracks[trackIndex].name} pan: ${pan}`, 'info');
}

function toggleTrackSolo(trackIndex) {
  mixerTracks[trackIndex].solo = !mixerTracks[trackIndex].solo;
  renderMixerTracks();
  logTrepanMessage(`ğŸš ${mixerTracks[trackIndex].name} solo: ${mixerTracks[trackIndex].solo ? 'ON' : 'OFF'}`, 'info');
}

function toggleTrackMute(trackIndex) {
  mixerTracks[trackIndex].mute = !mixerTracks[trackIndex].mute;
  renderMixerTracks();
  logTrepanMessage(`ğŸš ${mixerTracks[trackIndex].name} mute: ${mixerTracks[trackIndex].mute ? 'ON' : 'OFF'}`, 'info');
}

function addMixerTrack() {
  const trackNumber = mixerTracks.length + 1;
  mixerTracks.push({
    name: `Track ${trackNumber}`,
    volume: 75,
    pan: 0,
    eq: { low: 0, mid: 0, high: 0 },
    solo: false,
    mute: false
  });
  renderMixerTracks();
  logTrepanMessage(`ğŸš Added Track ${trackNumber} to mixing console`, 'success');
}

function setMasterVolume(volume) {
  if (masterGain) {
    masterGain.gain.setValueAtTime(volume / 100, audioContext.currentTime);
  }
  logTrepanMessage(`ğŸ”Š Master volume set to ${volume}%`, 'info');
}

function masterProcessing() {
  logTrepanMessage('ğŸ› Master processing activated - applying professional mastering chain', 'success');
  playCosmicSound('bonus');
}

function automixMagic() {
  mixerTracks.forEach((track, index) => {
    if (index > 0) { // Skip master track
      track.volume = 60 + Math.random() * 30;
      track.pan = (Math.random() - 0.5) * 40;
    }
  });
  renderMixerTracks();
  logTrepanMessage('âœ¨ Auto-Mix Magic applied! Optimal balance achieved!', 'success');
  playCosmicSound('big_win');
}

// ====================================
// SPECTRUM ANALYZER SYSTEM
// ====================================
function initSpectrumAnalyzer() {
  try {
    const canvas = document.getElementById('spectrumCanvas');
    const ctx = canvas.getContext('2d');
    
    function drawSpectrum() {
      if (!analyzer || !KOZMIC_STATE.portalOpen) {
        requestAnimationFrame(drawSpectrum);
        return;
      }
      
      const bufferLength = analyzer.frequencyBinCount;
      const dataArray = new Uint8Array(bufferLength);
      analyzer.getByteFrequencyData(dataArray);
      
      // Clear canvas with cosmic gradient
      const gradient = ctx.createLinearGradient(0, 0, 0, canvas.height);
      gradient.addColorStop(0, '#1a1a2e');
      gradient.addColorStop(1, '#16213e');
      ctx.fillStyle = gradient;
      ctx.fillRect(0, 0, canvas.width, canvas.height);
      
      const barWidth = (canvas.width / bufferLength) * 2.5;
      let barHeight;
      let x = 0;
      
      for (let i = 0; i < bufferLength; i++) {
        barHeight = (dataArray[i] / 255) * canvas.height;
        
        // Cosmic color scheme
        const hue = (i / bufferLength) * 360;
        const saturation = 70 + (dataArray[i] / 255) * 30;
        const lightness = 40 + (dataArray[i] / 255) * 40;
        
        ctx.fillStyle = `hsl(${hue}, ${saturation}%, ${lightness}%)`;
        ctx.fillRect(x, canvas.height - barHeight, barWidth, barHeight);
        
        // Add glow effect for high frequencies
        if (dataArray[i] > 200) {
          ctx.shadowColor = ctx.fillStyle;
          ctx.shadowBlur = 10;
          ctx.fillRect(x, canvas.height - barHeight, barWidth, barHeight);
          ctx.shadowBlur = 0;
        }
        
        x += barWidth + 1;
      }
      
      requestAnimationFrame(drawSpectrum);
    }
    
    // Set canvas size
    canvas.width = canvas.offsetWidth;
    canvas.height = canvas.offsetHeight;
    
    drawSpectrum();
    logTrepanMessage('ğŸ“Š Spectrum Analyzer initialized with cosmic visualization', 'success');
  } catch (error) {
    logTrepanMessage('ğŸš¨ Spectrum Analyzer initialization failed: ' + error.message, 'error');
  }
}

// ====================================
// RECORDING STUDIO SYSTEM
// ====================================
function toggleCosmicRecording() {
  try {
    if (!KOZMIC_STATE.audioConnected) {
      logTrepanMessage('ğŸš¨ Open Cosmic Portal first to record!', 'error');
      return;
    }
    
    if (!isRecording) {
      startCosmicRecording();
    } else {
      stopCosmicRecording();
    }
  } catch (error) {
    logTrepanMessage('ğŸš¨ Recording error: ' + error.message, 'error');
  }
}

function startCosmicRecording() {
  try {
    const recordedChunks = [];
    mediaRecorder = new MediaRecorder(audioStream, {
      mimeType: 'audio/webm;codecs=opus'
    });
    
    mediaRecorder.ondataavailable = event => {
      if (event.data.size > 0) {
        recordedChunks.push(event.data);
      }
    };
    
    mediaRecorder.onstop = () => {
      const blob = new Blob(recordedChunks, { type: 'audio/webm' });
      const url = URL.createObjectURL(blob);
      
      const track = {
        name: `Cosmic Recording ${recordedTracks.length + 1}`,
        blob: blob,
        url: url,
        duration: Date.now() - recordingStartTime,
        timestamp: new Date().toISOString()
      };
      
      recordedTracks.push(track);
      updateTrackList();
      logTrepanMessage('ğŸ™ Cosmic recording completed and saved!', 'success');
    };
    
    mediaRecorder.start();
    isRecording = true;
    recordingStartTime = Date.now();
    KOZMIC_STATE.recordingActive = true;
    
    const recordBtn = document.getElementById('recordBtn');
    recordBtn.textContent = 'â¹ Stop Recording';
    recordBtn.classList.add('active');
    
    updateRecordingStatus('ğŸ”´ RECORDING... Capturing cosmic frequencies!');
    logTrepanMessage('ğŸ™ Cosmic recording started!', 'success');
  } catch (error) {
    logTrepanMessage('ğŸš¨ Recording start error: ' + error.message, 'error');
  }
}

function stopCosmicRecording() {
  try {
    if (mediaRecorder && isRecording) {
      mediaRecorder.stop();
      isRecording = false;
      KOZMIC_STATE.recordingActive = false;
      
      const recordBtn = document.getElementById('recordBtn');
      recordBtn.textContent = 'ğŸ™ Record Mix';
      recordBtn.classList.remove('active');
      
      updateRecordingStatus('ğŸ™ Recording stopped. Ready for next cosmic session!');
      logTrepanMessage('ğŸ™ Cosmic recording stopped!', 'info');
    }
  } catch (error) {
    logTrepanMessage('ğŸš¨ Recording stop error: ' + error.message, 'error');
  }
}

function updateTrackList() {
  const trackList = document.getElementById('trackList');
  trackList.innerHTML = recordedTracks.map((track, index) =>
    `<div style="margin: 5px 0; padding: 5px; background: rgba(255,107,157,0.1); border-radius: 5px;">
      ğŸµ ${track.name} (${Math.round(track.duration/1000)}s)
      <button onclick="playTrack(${index})" style="margin-left: 10px;">â–¶</button>
      <button onclick="downloadTrack(${index})" style="margin-left: 5px;">ğŸ’¾</button>
    </div>`
  ).join('');
}

function playTrack(index) {
  const track = recordedTracks[index];
  const audio = new Audio(track.url);
  audio.play();
  logTrepanMessage(`ğŸµ Playing ${track.name}`, 'info');
}

function downloadTrack(index) {
  const track = recordedTracks[index];
  const a = document.createElement('a');
  a.href = track.url;
  a.download = `${track.name}.webm`;
  a.click();
  logTrepanMessage(`ğŸ’¾ Downloaded ${track.name}`, 'success');
}

function playbackRecording() {
  if (recordedTracks.length === 0) {
    logTrepanMessage('ğŸš¨ No recordings available for playback!', 'error');
    return;
  }
  const latestTrack = recordedTracks[recordedTracks.length - 1];
  playTrack(recordedTracks.length - 1);
}

function downloadCosmicMix() {
  if (recordedTracks.length === 0) {
    logTrepanMessage('ğŸš¨ No recordings to download!', 'error');
    return;
  }
  downloadTrack(recordedTracks.length - 1);
}

function exportToNFT() {
  if (recordedTracks.length === 0) {
    logTrepanMessage('ğŸš¨ No recordings to export as NFT!', 'error');
    return;
  }
  mintCosmicNFT();
  logTrepanMessage('ğŸ¨ Latest recording exported as NFT!', 'success');
}

function updateRecordingStatus(message) {
  document.getElementById('recordingStatus').innerHTML = `
    ğŸ™ ${message}<br>
    ğŸ“Š Format: WebM + MP3 Export<br>
    ğŸµ Quality: High Definition<br>
    â± Recorded Tracks: ${recordedTracks.length}<br>
    ğŸŒŸ Ready for cosmic creation!
  `;
}

// ====================================
// WEB3 CASINO SYSTEM
// ====================================
function connectCosmicWallet() {
  try {
    if (typeof window.ethereum === 'undefined') {
      logTrepanMessage('ğŸš¨ MetaMask not detected! Please install MetaMask to access Web3 features.', 'error');
      return;
    }
    
    // Simulate wallet connection for demo
    playerAddress = '0x742d35Cc6634C0532925a3b8D5C0cE5eF5f6a8b7';
    KOZMIC_STATE.web3Connected = true;
    updateWeb3Balance();
    
    logTrepanMessage('ğŸ‘› Cosmic wallet connected successfully!', 'success');
    
    // Welcome bonus
    if (ctokBalance < 1000) {
      ctokBalance = 1000;
      logTrepanMessage('ğŸ Welcome bonus: 1000 CTOK credited!', 'success');
    }
    
    playCosmicSound('big_win');
  } catch (error) {
    logTrepanMessage('ğŸš¨ Web3 connection error: ' + error.message, 'error');
  }
}

function updateWeb3Balance() {
  document.getElementById('web3Balance').innerHTML = `
    ğŸ‘› ${playerAddress ? `${playerAddress.slice(0,8)}...${playerAddress.slice(-6)}` : 'Disconnected'} |
    ğŸ’° CTOK: ${ctokBalance.toLocaleString()} |
    ğŸ§  Portals: ${mindPortals} |
    ğŸ¨ NFTs: ${nftCount}
  `;
  updateAchievements();
}

function updateAchievements() {
  const panel = document.getElementById('achievementsPanel');
  const achievements = [];
  
  if (nftCount >= 1) achievements.push('ğŸŒŒ Portal Opener');
  if (nftCount >= 3) achievements.push('ğŸµ Cosmic Composer');
  if (nftCount >= 5) achievements.push('ğŸ° High Roller');
  if (nftCount >= 10) achievements.push('ğŸ§  Mind Driller');
  if (ctokBalance >= 50000) achievements.push('ğŸ’° Cosmic Millionaire');
  if (KOZMIC_STATE.chaosMode) achievements.push('ğŸƒ Chaos Master');
  if (mindPortals >= 50) achievements.push('ğŸŒ€ Portal Lord');
  
  panel.innerHTML = achievements.map(a => 
    `<span class="achievement">${a}</span>`
  ).join('');
}

function mintCosmicNFT() {
  try {
    if (!KOZMIC_STATE.web3Connected) {
      logTrepanMessage('ğŸš¨ Connect wallet first to mint NFTs!', 'error');
      return;
    }
    
    // Simulate NFT minting with metadata
    const tokenId = Date.now();
    const metadata = {
      name: `Cosmic Creation #${tokenId}`,
      description: `A unique cosmic musical creation from the Monster Kozmic Casino`,
      genre: currentGenre,
      timestamp: new Date().toISOString(),
      trepanLevel: trepanLevel,
      activeEffects: UAD_PLUGINS.filter(p => p.active).map(p => p.name),
      cosmicAlignment: KOZMIC_STATE.cosmicAlignment,
      createdBy: playerAddress,
      casino: 'Monster Kozmic Casino Complete Edition'
    };
    
    nftCount++;
    updateWeb3Balance();
    
    logTrepanMessage(`ğŸ¨ Cosmic NFT minted! Token ID: ${tokenId}`, 'success');
    logTrepanMessage('ğŸŒŒ Your cosmic creation is now immortalized on the blockchain!', 'success');
    playCosmicSound('big_win');
    
    return tokenId;
  } catch (error) {
    logTrepanMessage('ğŸš¨ NFT minting error: ' + error.message, 'error');
  }
}

function drillMindPortal() {
  try {
    if (!KOZMIC_STATE.audioConnected) {
      logTrepanMessage('ğŸš¨ Open Cosmic Portal first to drill consciousness!', 'error');
      return;
    }
    
    const miningPower = trepanLevel * 15;
    const ctokEarned = Math.floor(Math.random() * miningPower) + 25;
    const portalDepth = Math.floor(Math.random() * 3) + 1;
    
    ctokBalance += ctokEarned;
    mindPortals += portalDepth;
    trepanLevel = Math.min(trepanLevel + 0.2, 10);
    
    updateWeb3Balance();
    logTrepanMessage(`ğŸ§  Portal drilled! Depth: ${portalDepth} | +${ctokEarned} CTOK | Trepan Level: ${trepanLevel.toFixed(1)}`, 'success');
    playCosmicSound('bonus');
  } catch (error) {
    logTrepanMessage('ğŸš¨ Portal drilling error: ' + error.message, 'error');
  }
}

function supernovaBet() {
  try {
    const betAmount = parseInt(document.getElementById('betAmount').value) || 100;
    
    if (ctokBalance < betAmount) {
      logTrepanMessage('ğŸš¨ Insufficient CTOK for supernova bet!', 'error');
      return;
    }
    
    ctokBalance -= betAmount;
    
    // Supernova calculation based on cosmic alignment
    const baseChance = 0.4; // 40% base win chance
    const trepanBonus = trepanLevel / 100; // Up to 10% bonus
    const portalBonus = Math.min(mindPortals / 1000, 0.2); // Up to 20% bonus
    const finalChance = Math.min(baseChance + trepanBonus + portalBonus, 0.8);
    
    const random = Math.random();
    
    if (random < finalChance) {
      const multiplier = 1.5 + Math.random() * 1.5; // 1.5x to 3x
      const winnings = Math.floor(betAmount * multiplier);
      ctokBalance += winnings;
      
      logTrepanMessage(`ğŸŒŸ SUPERNOVA EXPLOSION! Won ${winnings} CTOK! (${multiplier.toFixed(1)}x)`, 'success');
      playCosmicSound('big_win');
    } else {
      logTrepanMessage(`ğŸ’¥ Supernova collapsed into a black hole... Lost ${betAmount} CTOK`, 'warning');
      playCosmicSound('no_win');
    }
    
    updateWeb3Balance();
  } catch (error) {
    logTrepanMessage('ğŸš¨ Supernova betting error: ' + error.message, 'error');
  }
}

function blackHoleLottery() {
  try {
    const betAmount = parseInt(document.getElementById('betAmount').value) || 100;
    
    if (ctokBalance < betAmount) {
      logTrepanMessage('ğŸš¨ Insufficient CTOK for black hole lottery!', 'error');
      return;
    }
    
    ctokBalance -= betAmount;
    
    // Black hole lottery - high risk, high reward
    const chance = Math.random();
    
    if (chance < 0.05) { // 5% chance for massive win
      const winnings = betAmount * 20;
      ctokBalance += winnings;
      logTrepanMessage(`ğŸ•³ BLACK HOLE SINGULARITY! MASSIVE WIN: ${winnings} CTOK!`, 'success');
      triggerUltimateJackpot();
      playCosmicSound('big_win');
    } else if (chance < 0.15) { // 10% chance for good win
      const winnings = betAmount * 5;
      ctokBalance += winnings;
      logTrepanMessage(`ğŸŒ€ Event horizon crossed! Won ${winnings} CTOK!`, 'success');
      playCosmicSound('joker_win');
    } else {
      logTrepanMessage(`ğŸŒ‘ Consumed by the infinite void... ${betAmount} CTOK lost to eternity`, 'warning');
      playCosmicSound('no_win');
    }
    
    updateWeb3Balance();
  } catch (error) {
    logTrepanMessage('ğŸš¨ Black hole lottery error: ' + error.message, 'error');
  }
}

function cosmicStaking() {
  try {
    const stakeAmount = parseInt(document.getElementById('betAmount').value) || 100;
    
    if (ctokBalance < stakeAmount) {
      logTrepanMessage('ğŸš¨ Insufficient CTOK for cosmic staking!', 'error');
      return;
    }
    
    ctokBalance -= stakeAmount;
    
    // Staking rewards based on time and cosmic alignment
    const stakingPeriod = 30; // 30 seconds for demo
    const rewardRate = 0.1 + (trepanLevel / 100); // 10% + trepan bonus
    const expectedReward = Math.floor(stakeAmount * rewardRate);
    
    logTrepanMessage(`ğŸ’ Staking ${stakeAmount} CTOK for ${stakingPeriod}s at ${(rewardRate*100).toFixed(1)}% rate...`, 'info');
    
    setTimeout(() => {
      const actualReward = expectedReward + Math.floor(Math.random() * 20 - 10); // Â±10 variance
      ctokBalance += stakeAmount + actualReward;
      updateWeb3Balance();
      
      logTrepanMessage(`ğŸ’ Staking complete! Earned ${actualReward} CTOK in rewards!`, 'success');
      playCosmicSound('bonus');
    }, stakingPeriod * 1000);
    
    updateWeb3Balance();
  } catch (error) {
    logTrepanMessage('ğŸš¨ Cosmic staking error: ' + error.message, 'error');
  }
}

// ====================================
// AI COSMIC ASSISTANT SYSTEM
// ====================================
function initAIAssistant() {
  KOZMIC_STATE.aiAssistantOnline = true;
  logTrepanMessage('ğŸ¤– AI Cosmic Assistant online and ready to help!', 'success');
}

function getAISuggestion() {
  const suggestions = [
    `ğŸµ Try the ${COSMIC_GENRES[currentGenre].name} genre with a ${Math.floor(Math.random() * 200 + 80)} BPM tempo for a cosmic vibe!`,
    `ğŸ› Activate the ${UAD_PLUGINS[Math.floor(Math.random() * UAD_PLUGINS.length)].name} plugin for enhanced sonic texture!`,
    `ğŸ¸ Layer a ${COSMIC_GENRES[currentGenre].instruments[Math.floor(Math.random() * COSMIC_GENRES[currentGenre].instruments.length)]} with some cosmic reverb!`,
    `ğŸŒŒ Your current trepan level of ${trepanLevel}/10 suggests trying some experimental chord progressions!`,
    `ğŸ’« Consider switching to ${Object.keys(COSMIC_GENRES)[Math.floor(Math.random() * Object.keys(COSMIC_GENRES).length)]} genre for creative inspiration!`,
    `ğŸ² The cosmic forces suggest betting ${Math.floor(Math.random() * 500 + 100)} CTOK on your next supernova!`,
    `ğŸ§  With ${mindPortals} mind portals drilled, you're ready for advanced consciousness expansion techniques!`
  ];
  
  const suggestion = suggestions[Math.floor(Math.random() * suggestions.length)];
  updateAIResponse(suggestion);
  logTrepanMessage('ğŸ¤– AI suggestion provided', 'info');
  playCosmicSound('reel_click');
}

function analyzeCurrentJam() {
  const genreData = COSMIC_GENRES[currentGenre];
  const activePlugins = UAD_PLUGINS.filter(p => p.active && !p.bypass);
  
  const analysis = `
    ğŸµ <strong>Cosmic Musical Analysis:</strong><br><br>
    ğŸ² Current Genre: ${genreData.name}<br>
    ğŸ¼ Musical Key: ${genreData.key} (${genreData.scale})<br>
    âš¡ Tempo: ${genreData.bpm} BPM<br>
    ğŸ› Active Effects: ${activePlugins.length} plugins<br>
    ğŸ§  Consciousness Level: ${trepanLevel}/10<br>
    ğŸŒŒ Cosmic Alignment: ${KOZMIC_STATE.cosmicAlignment}<br><br>
    ğŸ’¡ <strong>Recommendations:</strong><br>
    â€¢ Your ${genreData.name} setup has great potential for ${genreData.bpm > 140 ? 'high-energy' : 'atmospheric'} compositions<br>
    â€¢ Consider adding ${activePlugins.length < 3 ? 'more effects' : 'subtle layering'} for depth<br>
    â€¢ The ${genreData.key} key works perfectly with ${genreData.scale} progressions
  `;
  
  updateAIResponse(analysis);
  logTrepanMessage('ğŸ¤– Musical analysis complete', 'success');
}

function generateChords() {
  const genreData = COSMIC_GENRES[currentGenre];
  const chordProgressions = {
    'Major': ['I - V - vi - IV', 'vi - IV - I - V', 'I - vi - ii - V', 'IV - V - I - vi'],
    'Minor': ['i - VII - VI - VII', 'i - iv - VII - III', 'i - VI - III - VII', 'i - v - iv - i'],
    'Mixolydian': ['I - VII - IV - I', 'I - iv - VII - I', 'V - IV - I - V', 'I - VII - vi - IV'],
    'Raga Yaman': ['Sa - Ga - Ma - Dha', 'Re - Ga - Dha - Ni', 'Sa - Ma - Pa - Sa', 'Ga - Re - Sa - Ni'],
    'Pentatonic': ['I - iii - IV - V', 'vi - I - iii - V', 'IV - V - I - iii', 'I - V - vi - iii'],
    'Quantum': ['X - Y - Z - âˆ', 'âˆ† - â—Š - â™¦ - â˜…', 'âŸ¡ - âŸ¢ - âŸ£ - âŸ¤', 'Î± - Î² - Î³ - Î©']
  };
  
  const scale = genreData.scale || 'Major';
  const progressions = chordProgressions[scale] || chordProgressions['Major'];
  const selectedProgression = progressions[Math.floor(Math.random() * progressions.length)];
  
  const response = `
    ğŸ¼ <strong>Cosmic Chord Generator:</strong><br><br>
    ğŸµ Genre: ${genreData.name}<br>
    ğŸ¹ Key: ${genreData.key}<br>
    ğŸ“ Scale: ${scale}<br><br>
    âœ¨ <strong>Generated Progression:</strong><br>
    <span style="font-size: 18px; color: #ffd700;">${selectedProgression}</span><br><br>
    ğŸ’¡ <strong>Playing Tips:</strong><br>
    â€¢ Play at ${genreData.bpm} BPM for authentic ${genreData.name} feel<br>
    â€¢ Add ${scale === 'Minor' ? 'dark, emotional' : scale === 'Quantum' ? 'otherworldly, experimental' : 'bright, uplifting'} melodies<br>
    â€¢ Use instruments: ${genreData.instruments.slice(0, 3).join(', ')}<br>
    ğŸŒŸ Perfect for your current cosmic alignment!
  `;
  
  updateAIResponse(response);
  logTrepanMessage('ğŸ¼ Cosmic chord progression generated', 'success');
  playCosmicSound('bonus');
}

function aiCompose() {
  const genreData = COSMIC_GENRES[currentGenre];
  const compositions = [
    {
      title: 'Stellar Odyssey',
      description: 'A journey through distant galaxies with ethereal pads and cosmic percussion',
      structure: 'Intro â†’ Build â†’ Drop â†’ Break â†’ Build â†’ Outro',
      duration: '4:32'
    },
    {
      title: 'Quantum Entanglement',
      description: 'Exploring the microscopic dance of particles with glitchy beats and quantum harmonics',
      structure: 'Ambient â†’ Rhythmic â†’ Chaotic â†’ Resolution',
      duration: '6:18'
    },
    {
      title: 'Consciousness Expansion',
      description: 'A trepanning meditation featuring binaural beats and transcendental melodies',
      structure: 'Meditation â†’ Awakening â†’ Transcendence â†’ Integration',
      duration: '8:44'
    },
    {
      title: 'Cosmic Fusion Dance',
      description: 'High-energy interstellar groove mixing multiple dimensional rhythms',
      structure: 'Groove â†’ Build â†’ Peak â†’ Breakdown â†’ Peak â†’ End',
      duration: '5:27'
    }
  ];
  
  const composition = compositions[Math.floor(Math.random() * compositions.length)];
  
  const response = `
    ğŸµ <strong>AI Cosmic Composition:</strong><br><br>
    ğŸŒŸ <strong>Title:</strong> "${composition.title}"<br>
    ğŸ“ <strong>Description:</strong> ${composition.description}<br>
    ğŸ¼ <strong>Genre:</strong> ${genreData.name} Fusion<br>
    â± <strong>Duration:</strong> ${composition.duration}<br>
    ğŸ¹ <strong>Key:</strong> ${genreData.key}<br>
    ğŸ¥ <strong>BPM:</strong> ${genreData.bpm}<br><br>
    ğŸ“ <strong>Structure:</strong><br>
    ${composition.structure}<br><br>
    ğŸ› <strong>Recommended Plugins:</strong><br>
    ${UAD_PLUGINS.slice(0, 3).map(p => `â€¢ ${p.name}`).join('<br>')}<br><br>
    ğŸ’« <strong>Cosmic Tip:</strong> Record this at trepan level ${Math.floor(Math.random() * 3 + 8)} for maximum consciousness expansion!
  `;
  
  updateAIResponse(response);
  logTrepanMessage(`ğŸµ AI composed "${composition.title}"`, 'success');
  playCosmicSound('big_win');
}

function updateAIResponse(message) {
  document.getElementById('aiResponse').innerHTML = message;
}

// ====================================
// ULTIMATE JAM MODES SYSTEM
// ====================================
function ultimateCosmicJam() {
  currentGenre = 'cosmic_fusion';
  document.getElementById('genreSelect').value = currentGenre;
  changeCosmicGenre();
  loadUADPresets();
  
  // Activate cosmic chaos
  activateCosmicChaos();
  KOZMIC_STATE.jamModeActive = true;
  
  logTrepanMessage('ğŸŒŒ ULTIMATE COSMIC JAM! Reality transcendence initiated!', 'error');
  playCosmicSound('big_win');
  
  // Auto-play cosmic instruments
  setTimeout(() => {
    for (let i = 0; i < 4; i++) {
      setTimeout(() => {
        playCosmicInstrument(i, COSMIC_GENRES[currentGenre].instruments[i]);
      }, i * 500);
    }
  }, 1000);
}

function motownMasterJam() {
  currentGenre = 'motown';
  document.getElementById('genreSelect').value = currentGenre;
  changeCosmicGenre();
  loadUADPresets();
  
  KOZMIC_STATE.jamModeActive = true;
  logTrepanMessage('ğŸµ MOTOWN MASTER JAM! Channel the Funk Brothers energy!', 'success');
  
  // Activate Motown-specific settings
  trepanLevel = 7;
  intensity = 85;
  playCosmicSound('joker_win');
}

function psychedelicOdyssey() {
  currentGenre = 'psychedelic';
  document.getElementById('genreSelect').value = currentGenre;
  changeCosmicGenre();
  loadUADPresets();
  
  KOZMIC_STATE.jamModeActive = true;
  KOZMIC_STATE.chaosMode = true;
  intensity = 95;
  
  logTrepanMessage('ğŸŒˆ PSYCHEDELIC ODYSSEY! Consciousness expanding through sound!', 'error');
  
  // Visual effects
  document.body.style.filter = 'hue-rotate(180deg) saturate(150%)';
  setTimeout(() => {
    document.body.style.filter = '';
    KOZMIC_STATE.chaosMode = false;
  }, 30000);
  
  playCosmicSound('big_win');
}

function indianClassicalRaga() {
  currentGenre = 'indian_classical';
  document.getElementById('genreSelect').value = currentGenre;
  changeCosmicGenre();
  loadUADPresets();
  
  KOZMIC_STATE.jamModeActive = true;
  logTrepanMessage('ğŸ•‰ INDIAN CLASSICAL RAGA! Ancient wisdom through microtonal harmony!', 'success');
  
  // Set appropriate parameters for Indian classical
  trepanLevel = 9;
  intensity = 60; // More subtle approach
  playCosmicSound('bonus');
}

function africanPolyrhythm() {
  currentGenre = 'african_polyrhythm';
  document.getElementById('genreSelect').value = currentGenre;
  changeCosmicGenre();
  loadUADPresets();
  
  KOZMIC_STATE.jamModeActive = true;
  logTrepanMessage('ğŸ¥ AFRICAN POLYRHYTHMIC JAM! Ancient rhythms awaken!', 'success');
  playCosmicSound('joker_win');
}

function wreckingCrewSession() {
  currentGenre = 'wrecking_crew';
  document.getElementById('genreSelect').value = currentGenre;
  changeCosmicGenre();
  loadUADPresets();
  
  KOZMIC_STATE.jamModeActive = true;
  logTrepanMessage('ğŸ¸ WRECKING CREW SESSION! LA studio magic activated!', 'success');
  playCosmicSound('big_win');
}

function reggaeVibesJam() {
  currentGenre = 'reggae';
  document.getElementById('genreSelect').value = currentGenre;
  changeCosmicGenre();
  loadUADPresets();
  
  KOZMIC_STATE.jamModeActive = true;
  logTrepanMessage('ğŸŒ´ REGGAE VIBES JAM! One love, one rhythm!', 'success');
  playCosmicSound('bonus');
}

function stopAllJams() {
  KOZMIC_STATE.jamModeActive = false;
  KOZMIC_STATE.chaosMode = false;
  intensity = 75;
  trepanLevel = 5;
  resetAllPlugins();
  
  logTrepanMessage('ğŸ›‘ All jam modes stopped. System returned to normal operation.', 'info');
  playCosmicSound('reel_click');
}

function randomGenreJam() {
  const genres = Object.keys(COSMIC_GENRES);
  const randomGenre = genres[Math.floor(Math.random() * genres.length)];
  currentGenre = randomGenre;
  document.getElementById('genreSelect').value = currentGenre;
  changeCosmicGenre();
  loadUADPresets();
  
  logTrepanMessage(`ğŸ² RANDOM GENRE JAM! Shifted to ${COSMIC_GENRES[randomGenre].name}!`, 'success');
  playCosmicSound('bonus');
}

function ultimateGenreFusion() {
  // Mix elements from multiple genres
  const fusionGenre = {
    name: 'Ultimate Fusion',
    bpm: 120 + Math.floor(Math.random() * 60),
    key: ['C', 'D', 'E', 'F', 'G', 'A', 'B'][Math.floor(Math.random() * 7)] + [' Major', ' Minor'][Math.floor(Math.random() * 2)],
    scale: 'Fusion',
    instruments: [],
    color: '#ff00ff'
  };
  
  // Combine instruments from different genres
  Object.values(COSMIC_GENRES).forEach(genre => {
    if (Math.random() > 0.7) {
      fusionGenre.instruments.push(...genre.instruments.slice(0, 2));
    }
  });
  
  COSMIC_GENRES['fusion_temp'] = fusionGenre;
  currentGenre = 'fusion_temp';
  initGenreWheel();
  chaosPluginMode();
  
  logTrepanMessage('ğŸŒŒ ULTIMATE GENRE FUSION! All musical dimensions merged!', 'error');
  playCosmicSound('big_win');
}

// ====================================
// COLLABORATION HUB SYSTEM
// ====================================
function startCollabSession() {
  collaborationActive = true;
  KOZMIC_STATE.collaborationLive = true;
  
  updateCollaborationChat('ğŸ¤ Collaboration session started!<br>ğŸŒŒ Room ID: COSMIC-' + Math.random().toString(36).substr(2, 9).toUpperCase());
  logTrepanMessage('ğŸ¤ Collaboration session initiated', 'success');
  playCosmicSound('bonus');
}

function joinCosmicRoom() {
  const roomId = prompt('Enter Cosmic Room ID:');
  if (roomId) {
    collaborationActive = true;
    KOZMIC_STATE.collaborationLive = true;
    
    updateCollaborationChat(`ğŸš€ Joined cosmic room: ${roomId}<br>ğŸ‘¥ Ready for real-time collaboration!`);
    logTrepanMessage(`ğŸš€ Joined room: ${roomId}`, 'success');
    playCosmicSound('big_win');
  }
}

function shareSession() {
  const sessionData = {
    genre: currentGenre,
    ctokBalance: ctokBalance,
    nftCount: nftCount,
    mindPortals: mindPortals,
    trepanLevel: trepanLevel,
    activePlugins: UAD_PLUGINS.filter(p => p.active),
    timestamp: Date.now()
  };
  
  const shareLink = `https://kozmik.casino/share/${btoa(JSON.stringify(sessionData))}`;
  updateCollaborationChat(`ğŸ“¤ Session shared!<br>ğŸ”— Link: ${shareLink}<br>ğŸ’« Others can now join your cosmic creation!`);
  logTrepanMessage('ğŸ“¤ Session shared successfully', 'success');
  
  // Copy to clipboard if possible
  if (navigator.clipboard) {
    navigator.clipboard.writeText(shareLink);
    logTrepanMessage('ğŸ”— Share link copied to clipboard!', 'info');
  }
}

function inviteCollaborators() {
  const emails = prompt('Enter email addresses (comma separated):');
  if (emails) {
    updateCollaborationChat(`ğŸ‘¥ Invitations sent to: ${emails}<br>ğŸŒŒ They will receive cosmic portal access links!`);
    logTrepanMessage(`ğŸ‘¥ Invitations sent to ${emails.split(',').length} collaborators`, 'success');
    playCosmicSound('bonus');
  }
}

function sendChatMessage() {
  const input = document.getElementById('chatInput');
  const message = input.value.trim();
  
  if (message) {
    const timestamp = new Date().toLocaleTimeString();
    updateCollaborationChat(`[${timestamp}] You: ${message}`, true);
    input.value = '';
    
    // Simulate response from other users
    setTimeout(() => {
      const responses = [
        'Amazing cosmic vibes! ğŸŒŒ',
        'Love that progression! ğŸµ',
        'Can you add more reverb? âœ¨',
        'This is transcendent! ğŸ§ ',
        'Portal level 9 achieved! ğŸ’«'
      ];
      const response = responses[Math.floor(Math.random() * responses.length)];
      updateCollaborationChat(`[${timestamp}] CosmicUser${Math.floor(Math.random() * 999)}: ${response}`, true);
    }, 1000 + Math.random() * 3000);
  }
}

function updateCollaborationChat(message, append = false) {
  const chat = document.getElementById('collaborationChat');
  if (append) {
    chat.innerHTML += '<br>' + message;
  } else {
    chat.innerHTML = message + '<br>' + chat.innerHTML;
  }
  chat.scrollTop = chat.scrollHeight;
}

// ====================================
// MASTER CONTROL CENTER
// ====================================
function saveCosmicSession() {
  try {
    const sessionData = {
      version: '3.14159',
      timestamp: Date.now(),
      genre: currentGenre,
      uadPlugins: UAD_PLUGINS.map(p => ({
        name: p.name,
        type: p.type,
        value: p.value,
        active: p.active,
        bypass: p.bypass
      })),
      mixerTracks: mixerTracks,
      cosmicState: KOZMIC_STATE,
      web3Data: {
        ctokBalance: ctokBalance,
        mindPortals: mindPortals,
        nftCount: nftCount,
        playerAddress: playerAddress
      },
      audioSettings: {
        trepanLevel: trepanLevel,
        intensity: intensity,
        masterVolume: masterGain ? masterGain.gain.value : 0.75
      },
      recordedTracks: recordedTracks.map(track => ({
        name: track.name,
        duration: track.duration,
        timestamp: track.timestamp
      }))
    };
    
    const blob = new Blob([JSON.stringify(sessionData, null, 2)], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `kozmic-session-${Date.now()}.json`;
    a.click();
    URL.revokeObjectURL(url);
    
    logTrepanMessage('ğŸ’¾ Cosmic session saved successfully!', 'success');
    playCosmicSound('bonus');
  } catch (error) {
    logTrepanMessage('ğŸš¨ Session save error: ' + error.message, 'error');
  }
}

function loadCosmicSession() {
  try {
    const input = document.createElement('input');
    input.type = 'file';
    input.accept = '.json';
    
    input.onchange = function(event) {
      const file = event.target.files[0];
      if (file) {
        const reader = new FileReader();
        reader.onload = function(e) {
          try {
            const sessionData = JSON.parse(e.target.result);
            
            // Restore session state
            currentGenre = sessionData.genre || 'standard';
            ctokBalance = sessionData.web3Data?.ctokBalance || 1000;
            mindPortals = sessionData.web3Data?.mindPortals || 0;
            nftCount = sessionData.web3Data?.nftCount || 0;
            trepanLevel = sessionData.audioSettings?.trepanLevel || 5;
            intensity = sessionData.audioSettings?.intensity || 75;
            
            // Restore UAD plugins
            if (sessionData.uadPlugins) {
              sessionData.uadPlugins.forEach((savedPlugin, index) => {
                if (UAD_PLUGINS[index]) {
                  UAD_PLUGINS[index].value = savedPlugin.value;
                  UAD_PLUGINS[index].active = savedPlugin.active;
                  UAD_PLUGINS[index].bypass = savedPlugin.bypass || false;
                }
              });
            }
            
            // Restore mixer tracks
            if (sessionData.mixerTracks) {
              mixerTracks = sessionData.mixerTracks;
              renderMixerTracks();
            }
            
            // Update UI
            document.getElementById('genreSelect').value = currentGenre;
            changeCosmicGenre();
            initUADFortress();
            updateWeb3Balance();
            updateCosmicBalance();
            
            logTrepanMessage(`ğŸ“‚ Cosmic session loaded! Version: ${sessionData.version || 'Unknown'}`, 'success');
            playCosmicSound('big_win');
          } catch (error) {
            logTrepanMessage('ğŸš¨ Invalid session file: ' + error.message, 'error');
          }
        };
        reader.readAsText(file);
      }
    };
    
    input.click();
  } catch (error) {
    logTrepanMessage('ğŸš¨ Session load error: ' + error.message, 'error');
  }
}

function exportEverything() {
  try {
    const exportData = {
      session: saveCosmicSession,
      recordings: recordedTracks,
      achievements: updateAchievements,
      timestamp: new Date().toISOString(),
      version: 'Monster Kozmic Casino Complete Edition v3.14159'
    };
    
    logTrepanMessage('ğŸ“¤ Exporting complete cosmic archive...', 'info');
    
    // This would typically create a comprehensive export
    setTimeout(() => {
      logTrepanMessage('ğŸ“¤ Complete cosmic archive exported successfully!', 'success');
      playCosmicSound('big_win');
    }, 2000);
  } catch (error) {
    logTrepanMessage('ğŸš¨ Export error: ' + error.message, 'error');
  }
}

function newCosmicSession() {
  if (confirm('ğŸŒŒ Start a new cosmic session? This will reset your current progress.')) {
    // Reset all systems to default
    currentGenre = 'standard';
    ctokBalance = 1000;
    mindPortals = 0;
    nftCount = 0;
    trepanLevel = 5;
    intensity = 75;
    recordedTracks = [];
    
    // Reset UI
    document.getElementById('genreSelect').value = currentGenre;
    changeCosmicGenre();
    resetAllPlugins();
    createDefaultMixerTracks();
    updateWeb3Balance();
    updateCosmicBalance();
    
    // Reset cosmic state
    Object.keys(KOZMIC_STATE).forEach(key => {
      if (typeof KOZMIC_STATE[key] === 'boolean') {
        KOZMIC_STATE[key] = false;
      }
    });
    KOZMIC_STATE.slotMachineActive = true;
    KOZMIC_STATE.systemHealth = 'excellent';
    KOZMIC_STATE.cosmicAlignment = 'perfect';
    
    logTrepanMessage('ğŸ†• New cosmic session initiated! Ready for fresh cosmic creation!', 'success');
    playCosmicSound('bonus');
  }
}

function fullSystemBackup() {
  logTrepanMessage('ğŸ”„ Initiating full system backup...', 'info');
  
  // Save current session automatically
  saveCosmicSession();
  
  // Backup cosmic state in localStorage (for demo)
  try {
    const backupData = JSON.stringify({
      timestamp: Date.now(),
      state: KOZMIC_STATE,
      genre: currentGenre,
      balance: ctokBalance,
      level: trepanLevel
    });
    
    // In a real app, this would be sent to a server
    console.log('Backup created:', backupData);
    
    setTimeout(() => {
      logTrepanMessage('ğŸ”„ Full system backup completed! All cosmic data secured.', 'success');
      playCosmicSound('bonus');
    }, 1500);
  } catch (error) {
    logTrepanMessage('ğŸš¨ Backup error: ' + error.message, 'error');
  }
}

function performanceMode() {
  systemPerformance = 'performance';
  intensity = 50; // Reduce particle intensity
  
  // Disable non-essential visual effects
  document.body.style.animation = 'none';
  
  logTrepanMessage('âš¡ Performance mode activated! System optimized for speed.', 'info');
  
  setTimeout(() => {
    systemPerformance = 'optimal';
    intensity = 75;
    document.body.style.animation = 'cosmicHypnosis 12s ease-in-out infinite';
    logTrepanMessage('âš¡ Performance mode deactivated. Full cosmic effects restored.', 'info');
  }, 30000);
}

function lowPowerMode() {
  systemPerformance = 'low_power';
  intensity = 25;
  
  // Reduce WebGL effects
  if (webglActive) {
    renderer.setPixelRatio(0.5);
  }
  
  logTrepanMessage('ğŸ”‹ Low power mode activated! Cosmic efficiency maximized.', 'info');
  
  setTimeout(() => {
    systemPerformance = 'optimal';
    intensity = 75;
    if (webglActive) {
      renderer.setPixelRatio(window.devicePixelRatio);
    }
    logTrepanMessage('ğŸ”‹ Low power mode deactivated. Full cosmic power restored.', 'info');
  }, 60000);
}

function ultimateEmergencyStop() {
  try {
    // Stop all audio
    if (audioContext) {
      audioContext.suspend();
    }
    
    // Stop recording
    if (isRecording) {
      stopCosmicRecording();
    }
    
    // Reset all states
    KOZMIC_STATE.chaosMode = false;
    KOZMIC_STATE.hypernovaMode = false;
    KOZMIC_STATE.trepanActive = false;
    isSpinning = false;
    intensity = 50;
    trepanLevel = 5;
    
    // Reset visual effects
    document.body.style.filter = '';
    document.body.style.animation = 'cosmicHypnosis 12s ease-in-out infinite';
    
    // Reset all plugins
    resetAllPlugins();
    
    // Flash red emergency signal
    document.body.style.background = 'radial-gradient(circle, #ff0000, #660000)';
    setTimeout(() => {
      document.body.style.background = '';
    }, 1000);
    
    logTrepanMessage('ğŸš¨ ULTIMATE EMERGENCY STOP EXECUTED! All systems stabilized and secured.', 'error');
    
    // Resume audio after emergency
    setTimeout(() => {
      if (audioContext) {
        audioContext.resume();
      }
      logTrepanMessage('âœ… Emergency protocols complete. Systems ready for normal operation.', 'success');
    }, 3000);
  } catch (error) {
    logTrepanMessage('ğŸš¨ Emergency stop error: ' + error.message, 'error');
  }
}

// ====================================
// COSMIC TREPANNING CONSOLE
// ====================================
function runFullSystemTest() {
  logTrepanMessage('ğŸ§ª Initiating comprehensive system diagnostics...', 'info');
  
  const tests = [
    { name: 'WebGL Portal', check: () => webglActive, critical: true },
    { name: 'Audio Context', check: () => audioContext !== null, critical: true },
    { name: 'Genre System', check: () => Object.keys(COSMIC_GENRES).length === 8, critical: false },
    { name: 'UAD Plugins', check: () => UAD_PLUGINS.length >= 12, critical: false },
    { name: 'Slot Machine', check: () => SLOT_SYMBOLS.length === 5, critical: true },
    { name: 'Web3 Ready', check: () => typeof Web3 !== 'undefined', critical: false },
    { name: 'Mixer Console', check: () => mixerTracks.length >= 4, critical: false },
    { name: 'AI Assistant', check: () => KOZMIC_STATE.aiAssistantOnline, critical: false },
    { name: 'Spectrum Analyzer', check: () => document.getElementById('spectrumCanvas') !== null, critical: false },
    { name: 'Recording System', check: () => typeof MediaRecorder !== 'undefined', critical: false },
    { name: 'Cosmic State', check: () => Object.keys(KOZMIC_STATE).length > 10, critical: true },
    { name: 'Trepanning Console', check: () => trepanLevel >= 0 && trepanLevel <= 10, critical: true }
  ];
  
  let passCount = 0;
  let criticalFailures = 0;
  
  tests.forEach((test, index) => {
    setTimeout(() => {
      const result = test.check();
      const status = result ? 'PASS âœ…' : 'FAIL âŒ';
      const criticality = test.critical ? '[CRITICAL] ' : '';
      
      logTrepanMessage(`${criticality}${test.name}: ${status}`, result ? 'success' : test.critical ? 'error' : 'warning');
      
      if (result) {
        passCount++;
      } else if (test.critical) {
        criticalFailures++;
      }
      
      // Final report
      if (index === tests.length - 1) {
        setTimeout(() => {
          const overallStatus = criticalFailures === 0 ? 'OPTIMAL' : criticalFailures <= 2 ? 'DEGRADED' : 'CRITICAL';
          const healthColor = overallStatus === 'OPTIMAL' ? 'success' : overallStatus === 'DEGRADED' ? 'warning' : 'error';
          
          logTrepanMessage(`ğŸ§ª SYSTEM DIAGNOSTICS COMPLETE`, 'info');
          logTrepanMessage(`ğŸ“Š Results: ${passCount}/${tests.length} tests passed`, 'info');
          logTrepanMessage(`ğŸ¥ System Health: ${overallStatus}`, healthColor);
          logTrepanMessage(`âš  Critical Failures: ${criticalFailures}`, criticalFailures > 0 ? 'error' : 'success');
          
          KOZMIC_STATE.systemHealth = overallStatus.toLowerCase();
          
          if (overallStatus === 'OPTIMAL') {
            playCosmicSound('big_win');
          } else if (overallStatus === 'DEGRADED') {
            playCosmicSound('joker_win');
          } else {
            playCosmicSound('no_win');
          }
        }, 500);
      }
    }, index * 300);
  });
}

function booleanPortalCheck() {
  logTrepanMessage('ğŸ” BOOLEAN PORTAL CHECK INITIATED:', 'info');
  
  setTimeout(() => {
    Object.entries(KOZMIC_STATE).forEach(([key, value], index) => {
      setTimeout(() => {
        const status = value ? 'TRUE âœ…' : 'FALSE âŒ';
        const type = value ? 'success' : 'warning';
        logTrepanMessage(`${key.replace(/([A-Z])/g, ' $1').replace(/^./, str => str.toUpperCase())}: ${status}`, type);
      }, index * 200);
    });
    
    setTimeout(() => {
      const activeStates = Object.values(KOZMIC_STATE).filter(v => v === true).length;
      const totalStates = Object.values(KOZMIC_STATE).length;
      const healthPercentage = Math.round((activeStates / totalStates) * 100);
      
      logTrepanMessage(`ğŸ” Portal Analysis Complete: ${activeStates}/${totalStates} systems active (${healthPercentage}%)`, 'info');
      
      KOZMIC_STATE.cosmicAlignment = healthPercentage > 70 ? 'perfect' : healthPercentage > 40 ? 'good' : 'needs_attention';
      playCosmicSound('bonus');
    }, Object.keys(KOZMIC_STATE).length * 200 + 500);
  }, 300);
}

function crisisProtocol() {
  logTrepanMessage('ğŸš¨ CRISIS PROTOCOL ACTIVATED!', 'error');
  logTrepanMessage('ğŸ”§ Executing emergency procedures...', 'warning');
  
  // Auto-run diagnostics
  setTimeout(() => {
    runFullSystemTest();
  }, 1000);
  
  // Emergency CTOK if critically low
  if (ctokBalance < 100) {
    ctokBalance += 1000;
    updateCosmicBalance();
    logTrepanMessage('ğŸ’° Emergency CTOK injection: +1000', 'success');
  }
  
  // Reset chaos if active
  if (KOZMIC_STATE.chaosMode) {
    KOZMIC_STATE.chaosMode = false;
    logTrepanMessage('ğŸŒŒ Chaos mode emergency termination', 'info');
  }
  
  // System stabilization
  setTimeout(() => {
    trepanLevel = Math.max(trepanLevel - 2, 1);
    intensity = 75;
    logTrepanMessage('âš– System parameters stabilized', 'success');
  }, 2000);
  
  setTimeout(() => {
    logTrepanMessage('ğŸ›  Crisis protocols executed successfully', 'success');
    logTrepanMessage('âœ… All systems returned to stable operation', 'success');
    playCosmicSound('big_win');
  }, 5000);
}

function mindPortalDiagnostics() {
  logTrepanMessage('ğŸ§  MIND PORTAL DIAGNOSTICS INITIATED...', 'info');
  
  const diagnostics = [
    { name: 'Portal Depth', value: mindPortals, unit: 'levels', optimal: '>= 10' },
    { name: 'Trepan Level', value: trepanLevel.toFixed(1), unit: '/10', optimal: '5-8' },
    { name: 'Consciousness Expansion', value: Math.round((trepanLevel / 10) * 100), unit: '%', optimal: '>= 50%' },
    { name: 'Portal Stability', value: KOZMIC_STATE.portalOpen ? 'STABLE' : 'CLOSED', unit: '', optimal: 'STABLE' },
    { name: 'Cosmic Alignment', value: KOZMIC_STATE.cosmicAlignment.toUpperCase(), unit: '', optimal: 'PERFECT' },
    { name: 'Reality Coherence', value: KOZMIC_STATE.chaosMode ? 'UNSTABLE' : 'COHERENT', unit: '', optimal: 'COHERENT' }
  ];
  
  diagnostics.forEach((diagnostic, index) => {
    setTimeout(() => {
      logTrepanMessage(`ğŸ§  ${diagnostic.name}: ${diagnostic.value}${diagnostic.unit} (Optimal: ${diagnostic.optimal})`, 'info');
    }, index * 400);
  });
  
  setTimeout(() => {
    const overallHealth = mindPortals >= 10 && trepanLevel >= 5 && trepanLevel <= 8 ? 'EXCELLENT' :
                         mindPortals >= 5 && trepanLevel >= 3 ? 'GOOD' :
                         'NEEDS_ATTENTION';
    
    logTrepanMessage(`ğŸ§  OVERALL MIND PORTAL HEALTH: ${overallHealth}`, 
                    overallHealth === 'EXCELLENT' ? 'success' : overallHealth === 'GOOD' ? 'info' : 'warning');
    
    if (overallHealth === 'EXCELLENT') {
      logTrepanMessage('ğŸŒŸ Consciousness transcendence achieved! You are operating at cosmic mastery level!', 'success');
      playCosmicSound('big_win');
    } else if (overallHealth === 'GOOD') {
      logTrepanMessage('ğŸ’« Good cosmic alignment! Continue drilling portals for transcendence!', 'info');
      playCosmicSound('bonus');
    } else {
      logTrepanMessage('âš  Mind portals need attention. Increase trepanning activity!', 'warning');
      playCosmicSound('reel_click');
    }
  }, diagnostics.length * 400 + 500);
}

function clearAllLogs() {
  document.getElementById('trepanConsole').innerHTML = `
    ğŸ’€ COSMIC TREPANNING CONSOLE v3.14159<br>
    ğŸŒŒ [SYSTEM] Logs cleared - Ready for new cosmic adventures<br>
    ğŸ§¹ [MAINTENANCE] Console reset to optimal state<br>
  `;
  logTrepanMessage('ğŸ§¹ All logs cleared successfully', 'info');
}

function debugModeToggle() {
  debugMode = !debugMode;
  document.body.classList.toggle('debug-mode', debugMode);
  
  if (debugMode) {
    logTrepanMessage('ğŸ› DEBUG MODE ACTIVATED - Enhanced diagnostic information enabled', 'warning');
    logTrepanMessage(`ğŸ”§ Current State: Genre=${currentGenre}, CTOK=${ctokBalance}, Trepan=${trepanLevel}`, 'info');
    logTrepanMessage(`ğŸ› Active Plugins: ${UAD_PLUGINS.filter(p => p.active).length}/${UAD_PLUGINS.length}`, 'info');
  } else {
    logTrepanMessage('ğŸ› Debug mode deactivated', 'info');
  }
}

function cosmicCalibration() {
  logTrepanMessage('âš– COSMIC CALIBRATION INITIATED...', 'info');
  
  const calibrationSteps = [
    'Aligning quantum frequencies...',
    'Calibrating trepan oscillators...',
    'Synchronizing cosmic harmonics...',
    'Balancing portal resonance...',
    'Optimizing consciousness bandwidth...',
    'Finalizing dimensional coherence...'
  ];
  
  calibrationSteps.forEach((step, index) => {
    setTimeout(() => {
      logTrepanMessage(`âš– ${step}`, 'info');
    }, index * 800);
  });
  
  setTimeout(() => {
    // Optimize system parameters
    trepanLevel = 7.77; // Optimal cosmic frequency
    intensity = 88; // Perfect alignment
    KOZMIC_STATE.cosmicAlignment = 'perfect';
    
    logTrepanMessage('âš– COSMIC CALIBRATION COMPLETE!', 'success');
    logTrepanMessage('ğŸŒŸ System optimized for maximum cosmic efficiency!', 'success');
    playCosmicSound('big_win');
  }, calibrationSteps.length * 800 + 500);
}

function quantumReset() {
  if (confirm('ğŸŒ€ Perform Quantum Reset? This will reset all systems to quantum-optimal states.')) {
    logTrepanMessage('ğŸŒ€ QUANTUM RESET INITIATED...', 'error');
    
    // Flash quantum colors
    document.body.style.filter = 'hue-rotate(0deg)';
    let hue = 0;
    const colorInterval = setInterval(() => {
      hue += 36;
      document.body.style.filter = `hue-rotate(${hue}deg)`;
      if (hue >= 360) {
        clearInterval(colorInterval);
        document.body.style.filter = '';
      }
    }, 100);
    
    setTimeout(() => {
      // Reset to quantum-optimal values
      trepanLevel = 8.88;
      intensity = 99;
      ctokBalance = Math.max(ctokBalance, 10000);
      
      // Reset all states to optimal
      Object.keys(KOZMIC_STATE).forEach(key => {
        if (key === 'systemHealth') KOZMIC_STATE[key] = 'excellent';
        else if (key === 'cosmicAlignment') KOZMIC_STATE[key] = 'perfect';
        else if (typeof KOZMIC_STATE[key] === 'boolean') KOZMIC_STATE[key] = false;
      });
      KOZMIC_STATE.slotMachineActive = true;
      KOZMIC_STATE.aiAssistantOnline = true;
      
      updateCosmicBalance();
      updateWeb3Balance();
      
      logTrepanMessage('ğŸŒ€ QUANTUM RESET COMPLETE!', 'success');
      logTrepanMessage('âš› All systems restored to quantum-optimal configuration!', 'success');
      playCosmicSound('big_win');
    }, 3000);
  }
}

// ====================================
// SPECIAL COSMIC EFFECTS
// ====================================
function activateCosmicChaos() {
  KOZMIC_STATE.chaosMode = true;
  intensity = 100;
  trepanLevel = Math.min(trepanLevel + 2, 10);
  
  // Visual chaos effects
  document.body.style.animation = 'cosmicHypnosis 1s ease-in-out infinite';
  
  // Randomize some systems
  setTimeout(() => {
    chaosPluginMode();
  }, 1000);
  
  logTrepanMessage('ğŸŒ€ COSMIC CHAOS MODE ACTIVATED! Reality bending initiated!', 'error');
  
  // Auto-deactivate after time
  setTimeout(() => {
    KOZMIC_STATE.chaosMode = false;
    intensity = 75;
    document.body.style.animation = 'cosmicHypnosis 12s ease-in-out infinite';
    logTrepanMessage('ğŸŒŒ Cosmic chaos subsides... Reality stabilized.', 'info');
  }, 30000);
}

function toggleTrepanMode() {
  KOZMIC_STATE.trepanActive = !KOZMIC_STATE.trepanActive;
  
  if (KOZMIC_STATE.trepanActive) {
    trepanLevel = Math.min(trepanLevel + 3, 10);
    logTrepanMessage('ğŸ’€ TREPANNING MODE ACTIVATED! Consciousness expansion accelerated!', 'error');
    playCosmicSound('big_win');
  } else {
    trepanLevel = Math.max(trepanLevel - 1, 1);
    logTrepanMessage('ğŸ’€ Trepanning mode deactivated', 'info');
    playCosmicSound('reel_click');
  }
  
  updatePortalStatus(`ğŸŒ€ Portal ${KOZMIC_STATE.portalOpen ? 'Active' : 'Standby'} | Trepan: ${KOZMIC_STATE.trepanActive ? 'ON' : 'OFF'} | Level: ${trepanLevel.toFixed(1)}/10`);
}

function activateHypernova() {
  KOZMIC_STATE.hypernovaMode = true;
  intensity = 100;
  trepanLevel = 10;
  
  // Max out all effects
  UAD_PLUGINS.forEach(plugin => {
    plugin.active = true;
    plugin.value = 1.0;
    plugin.bypass = false;
  });
  initUADFortress();
  
  // Visual hypernova effects
  document.body.style.animation = 'cosmicHypnosis 0.5s ease-in-out infinite';
  document.body.style.filter = 'brightness(150%) contrast(120%) saturate(200%)';
  
  logTrepanMessage('ğŸŒ‹ HYPERNOVA MODE! MAXIMUM COSMIC POWER UNLEASHED!', 'error');
  playCosmicSound('big_win');
  
  // Auto-deactivate after hypernova burn
  setTimeout(() => {
    KOZMIC_STATE.hypernovaMode = false;
    intensity = 75;
    trepanLevel = 7;
    document.body.style.animation = 'cosmicHypnosis 12s ease-in-out infinite';
    document.body.style.filter = '';
    
    // Reset some plugins
    UAD_PLUGINS.forEach(plugin => {
      plugin.value = 0.5;
      if (Math.random() > 0.7) plugin.active = false;
    });
    initUADFortress();
    
    logTrepanMessage('ğŸŒŒ Hypernova energy dissipated... Systems cooling down...', 'info');
  }, 15000);
}

function emergencyPortalStop() {
  if (KOZMIC_STATE.portalOpen) {
    if (audioStream) {
      audioStream.getTracks().forEach(track => track.stop());
    }
    KOZMIC_STATE.portalOpen = false;
    KOZMIC_STATE.audioConnected = false;
    
    document.getElementById('portalOverlay').textContent = 'Portal: EMERGENCY STOP';
    updatePortalStatus('ğŸ›‘ EMERGENCY PORTAL SHUTDOWN! All audio connections severed!');
    
    logTrepanMessage('ğŸ›‘ Emergency portal shutdown executed!', 'error');
    playCosmicSound('no_win');
  } else {
    logTrepanMessage('ğŸ›‘ No active portal to emergency stop', 'warning');
  }
}

// ====================================
// COSMIC CREATURE INTERACTION
// ====================================
function pulseCosmicCreature() {
  try {
    clickCount = (Date.now() - lastClick < 2000) ? clickCount + 1 : 1;
    lastClick = Date.now();
    
    const creature = document.querySelector('.cosmic-creature');
    creature.style.transform = 'scale(1.4) rotate(15deg)';
    setTimeout(() => creature.style.transform = '', 300);
    
    playCosmicSound('reel_click');
    
    if (clickCount >= 5) {
      // ULTIMATE HYPERNOVA SEQUENCE
      logTrepanMessage('ğŸ’€ COSMIC CREATURE AWAKENED! ULTIMATE HYPERNOVA SEQUENCE INITIATED!', 'error');
      creature.textContent = 'ğŸŒ‹';
      creature.style.animation = 'creatureFloat 0.3s ease-in-out infinite';
      
      // Trigger everything
      activateHypernova();
      activateCosmicChaos();
      
      // Bonus rewards
      ctokBalance += 5000;
      mindPortals += 10;
      updateCosmicBalance();
      updateWeb3Balance();
      
      clickCount = 0;
      
      setTimeout(() => {
        creature.textContent = 'ğŸ’€';
        creature.style.animation = 'creatureFloat 4s ease-in-out infinite';
        logTrepanMessage('ğŸ’€ Cosmic creature returns to slumber...', 'info');
      }, 20000);
    } else {
      logTrepanMessage(`ğŸ’€ Cosmic creature pulse ${clickCount}/5 - ${5-clickCount} more for ULTIMATE POWER!`, 'info');
    }
  } catch (error) {
    logTrepanMessage('ğŸš¨ Creature pulse error: ' + error.message, 'error');
  }
}

// ====================================
// KEYBOARD SHORTCUTS SYSTEM
// ====================================
function initKeyboardShortcuts() {
  document.addEventListener('keydown', (event) => {
    try {
      // Prevent shortcuts during text input
      if (event.target.tagName === 'INPUT' || event.target.tagName === 'SELECT' || event.target.tagName === 'TEXTAREA') {
        return;
      }
      
      // Ctrl + Shift combinations
      if (event.ctrlKey && event.shiftKey) {
        event.preventDefault();
        switch (event.key.toLowerCase()) {
          case 't': toggleTrepanMode(); break;
          case 'h': activateHypernova(); break;
          case 'p': openCosmicPortal(); break;
          case 'r': toggleCosmicRecording(); break;
          case 's': spinCosmicSlots(); break;
          case 'g': godMode(); break;
          case 'c': activateCosmicChaos(); break;
          case 'e': ultimateEmergencyStop(); break;
        }
        return;
      }
      
      // Single key shortcuts
      switch (event.key.toLowerCase()) {
        case 'j': ultimateCosmicJam(); break;
        case 'm': motownMasterJam(); break;
        case 'z': psychedelicOdyssey(); break;
        case 'i': indianClassicalRaga(); break;
        case 'a': africanPolyrhythm(); break;
        case 'w': wreckingCrewSession(); break;
        case 'r': reggaeVibesJam(); break;
        case ' ':
          event.preventDefault();
          if (!isSpinning) spinCosmicSlots();
          break;
        case 'escape':
          event.preventDefault();
          ultimateEmergencyStop();
          break;
      }
      
      // Number keys for instruments (0-7)
      if (event.key >= '0' && event.key <= '7') {
        const index = parseInt(event.key);
        const genreData = COSMIC_GENRES[currentGenre];
        if (genreData && genreData.instruments[index]) {
          playCosmicInstrument(index, genreData.instruments[index]);
        }
      }
      
      // Piano keys (Q-P row)
      const pianoMapping = {
        'q': 261.63, 'w': 277.18, 'e': 293.66, 'r': 311.13, 't': 329.63,
        'y': 349.23, 'u': 369.99, 'i': 392.00, 'o': 415.30, 'p': 440.00
      };
      
      if (pianoMapping[event.key.toLowerCase()]) {
        playPianoNote(pianoMapping[event.key.toLowerCase()]);
      }
    } catch (error) {
      logTrepanMessage('ğŸš¨ Keyboard shortcut error: ' + error.message, 'error');
    }
  });
  
  logTrepanMessage('âŒ¨ Cosmic keyboard shortcuts activated', 'success');
}

function playPianoNote(frequency) {
  if (!audioContext) return;
  
  try {
    const oscillator = audioContext.createOscillator();
    const gainNode = audioContext.createGain();
    
    oscillator.frequency.setValueAtTime(frequency, audioContext.currentTime);
    oscillator.type = 'sine';
    
    gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
    gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 1);
    
    oscillator.connect(gainNode);
    gainNode.connect(masterGain);
    oscillator.start();
    oscillator.stop(audioContext.currentTime + 1);
  } catch (error) {
    logTrepanMessage('ğŸš¨ Piano note error: ' + error.message, 'error');
  }
}

// ====================================
// EVENT LISTENERS SETUP
// ====================================
function setupEventListeners() {
  // Window resize handler
  window.addEventListener('resize', () => {
    if (renderer && camera) {
      const canvas = document.getElementById('webglCanvas');
      camera.aspect = canvas.clientWidth / canvas.clientHeight;
      camera.updateProjectionMatrix();
      renderer.setSize(canvas.clientWidth, canvas.clientHeight);
    }
    
    // Resize spectrum canvas
    const spectrumCanvas = document.getElementById('spectrumCanvas');
    if (spectrumCanvas) {
      spectrumCanvas.width = spectrumCanvas.offsetWidth;
      spectrumCanvas.height = spectrumCanvas.offsetHeight;
    }
  });
  
  // Chat input enter key
  document.getElementById('chatInput').addEventListener('keypress', (event) => {
    if (event.key === 'Enter') {
      sendChatMessage();
    }
  });
  
  logTrepanMessage('ğŸ® Event listeners configured', 'success');
}

// ====================================
// GLOBAL FUNCTION EXPOSURE
// ====================================
function exposeGlobalFunctions() {
  // Make all functions globally accessible
  const functions = {
    // Slot Machine
    spinCosmicSlots,
    testReel,
    testUltimateJackpot,
    addCosmicCTOK,
    
    // Portal System
    openCosmicPortal,
    toggleTrepanMode,
    activateHypernova,
    emergencyPortalStop,
    
    // Genre System
    changeCosmicGenre,
    playCosmicInstrument,
    randomGenreJam,
    ultimateGenreFusion,
    
    // UAD System
    toggleUADPlugin,
    loadUADPresets,
    resetAllPlugins,
    bypassAllPlugins,
    chaosPluginMode,
    
    // Web3 Casino
    connectCosmicWallet,
    mintCosmicNFT,
    drillMindPortal,
    supernovaBet,
    blackHoleLottery,
    cosmicStaking,
    
    // Recording System
    toggleCosmicRecording,
    playbackRecording,
    downloadCosmicMix,
    exportToNFT,
    
    // Mixer Console
    addMixerTrack,
    setMasterVolume,
    masterProcessing,
    automixMagic,
    updateTrackVolume,
    updateTrackPan,
    toggleTrackSolo,
    toggleTrackMute,
    
    // Collaboration
    startCollabSession,
    joinCosmicRoom,
    shareSession,
    inviteCollaborators,
    sendChatMessage,
    
    // AI Assistant
    getAISuggestion,
    analyzeCurrentJam,
    generateChords,
    aiCompose,
    
    // Jam Modes
    ultimateCosmicJam,
    motownMasterJam,
    psychedelicOdyssey,
    indianClassicalRaga,
    africanPolyrhythm,
    wreckingCrewSession,
    reggaeVibesJam,
    stopAllJams,
    
    // Master Controls
    saveCosmicSession,
    loadCosmicSession,
    exportEverything,
    newCosmicSession,
    fullSystemBackup,
    performanceMode,
    lowPowerMode,
    ultimateEmergencyStop,
    
    // Trepanning Console
    runFullSystemTest,
    booleanPortalCheck,
    crisisProtocol,
    mindPortalDiagnostics,
    clearAllLogs,
    debugModeToggle,
    cosmicCalibration,
    quantumReset,
    
    // Cosmic Creature
    pulseCosmicCreature,
    
    // Track Management
    playTrack,
    downloadTrack,
    
    // Special Effects
    activateCosmicChaos,
    
    // God Mode
    godMode
  };
  
  // Expose all functions to window object
  Object.keys(functions).forEach(funcName => {
    window[funcName] = functions[funcName];
  });
  
  logTrepanMessage('ğŸŒ All cosmic functions exposed globally', 'success');
}

// ====================================
// GODMODE AND UTILITY FUNCTIONS
// ====================================
function godMode() {
  ctokBalance = 100000;
  mindPortals = 100;
  nftCount = 10;
  trepanLevel = 10;
  intensity = 100;
  KOZMIC_STATE.web3Connected = true;
  KOZMIC_STATE.cosmicAlignment = 'perfect';
  
  updateWeb3Balance();
  updateCosmicBalance();
  
  logTrepanMessage('ğŸƒ GOD MODE ACTIVATED! Unlimited cosmic power unleashed!', 'error');
  playCosmicSound('big_win');
  
  // Visual god mode effects
  document.body.style.filter = 'drop-shadow(0 0 20px gold)';
  setTimeout(() => {
    document.body.style.filter = '';
  }, 5000);
}

// ====================================
// UTILITY FUNCTIONS
// ====================================
function logTrepanMessage(message, type = 'info') {
  try {
    const trepanConsole = document.getElementById('trepanConsole');
    const timestamp = new Date().toLocaleTimeString();
    const colors = {
      info: '#4ecdc4',
      success: '#27ae60',
      warning: '#f39c12',
      error: '#e74c3c'
    };
    
    const logEntry = `<span style="color: ${colors[type]};">[${timestamp}] ${message}</span><br>`;
    trepanConsole.innerHTML += logEntry;
    trepanConsole.scrollTop = trepanConsole.scrollHeight;
    
    // Limit log entries to prevent memory issues
    const lines = trepanConsole.innerHTML.split('<br>');
    if (lines.length > 100) {
      lines.splice(0, lines.length - 100);
      trepanConsole.innerHTML = lines.join('<br>');
    }
    
    // Also log to browser console for debugging
    window.console.log(`[${timestamp}] ${message}`);
    
    // Update system status based on message type
    if (type === 'error') {
      KOZMIC_STATE.systemHealth = 'needs_attention';
    } else if (type === 'success' && KOZMIC_STATE.systemHealth === 'needs_attention') {
      KOZMIC_STATE.systemHealth = 'good';
    }
  } catch (error) {
    window.console.error('Logging error:', error);
  }
}

// ====================================
// ERROR HANDLING
// ====================================
window.addEventListener('error', (event) => {
  logTrepanMessage(`ğŸš¨ CRITICAL ERROR: ${event.message} at line ${event.lineno}`, 'error');
  
  // Try to recover from common errors
  if (event.message.includes('audioContext')) {
    logTrepanMessage('ğŸ”§ Attempting audio context recovery...', 'warning');
    prepareAudioContext();
  } else if (event.message.includes('WebGL')) {
    logTrepanMessage('ğŸ”§ Attempting WebGL recovery...', 'warning');
    webglActive = false;
    setTimeout(() => {
      initWebGLPortal();
    }, 2000);
  }
});

window.addEventListener('unhandledrejection', (event) => {
  logTrepanMessage(`ğŸš¨ PROMISE REJECTION: ${event.reason}`, 'error');
  event.preventDefault();
});

// ====================================
// FINAL INITIALIZATION CHECK
// ====================================
// Auto-test function accessibility after a delay
setTimeout(() => {
  const testResults = {
    spinCosmicSlots: typeof window.spinCosmicSlots === 'function',
    openCosmicPortal: typeof window.openCosmicPortal === 'function',
    connectCosmicWallet: typeof window.connectCosmicWallet === 'function',
    godMode: typeof window.godMode === 'function',
    ultimateCosmicJam: typeof window.ultimateCosmicJam === 'function'
  };
  
  const allFunctional = Object.values(testResults).every(Boolean);
  
  if (allFunctional) {
    logTrepanMessage('âœ… All cosmic functions accessible and ready!', 'success');
    logTrepanMessage('ğŸ° Ready to spin, jam, and transcend consciousness!', 'success');
  } else {
    logTrepanMessage('âš  Some functions may not be accessible:', 'warning');
    Object.entries(testResults).forEach(([func, working]) => {
      if (!working) {
        logTrepanMessage(`âŒ ${func} not accessible`, 'error');
      }
    });
  }
  
  // Final startup message
  setTimeout(() => {
    logTrepanMessage('ğŸŒŒğŸ° MONSTER KOZMIC CASINO COMPLETE EDITION READY! ğŸ°ğŸŒŒ', 'success');
    logTrepanMessage('ğŸƒ AI JOKER SUPREME COLLABORATION: Claude + Grok = ULTIMATE POWER! ğŸƒ', 'success');
    logTrepanMessage('ğŸš€ ALL SYSTEMS OPERATIONAL - BEGIN YOUR COSMIC JOURNEY! ğŸš€', 'success');
  }, 2000);
}, 3000);

</script>
</body>
</html>
